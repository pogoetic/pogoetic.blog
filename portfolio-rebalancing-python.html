
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="kCbBEtjkoEnFU5Li1sxp5nchwEtLLyjRu3UlrCHjw-w" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://evgenypogorelov.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://evgenypogorelov.com/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://evgenypogorelov.com/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://evgenypogorelov.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Evgeny Pogorelov Atom">



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-131428314-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

<meta name="author" content="Evgeny Pogorelov" />
<meta name="description" content="A simple portfolio rebalancer using Pandas and the Tiingo API." />
<meta name="keywords" content="python, finance">

<meta property="og:site_name" content="Evgeny Pogorelov"/>
<meta property="og:title" content="Portfolio Rebalancing Using Python"/>
<meta property="og:description" content="A simple portfolio rebalancer using Pandas and the Tiingo API."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://evgenypogorelov.com/portfolio-rebalancing-python.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-12-17 16:37:00-08:00"/>
<meta property="article:modified_time" content="2018-12-17 16:37:00-08:00"/>
<meta property="article:author" content="https://evgenypogorelov.com/author/evgeny-pogorelov.html">
<meta property="article:section" content="posts"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="finance"/>
<meta property="og:image" content="https://evgenypogorelov.com/images/profile.jpeg">

  <title>Evgeny Pogorelov &ndash; Portfolio Rebalancing Using Python</title>

<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){
    w[l]=w[l]||[];
    w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
    j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
    f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WBFQQB6');
</script>
<!-- End Google Tag Manager -->  
    <link rel="canonical" href="https://evgenypogorelov.com/portfolio-rebalancing-python.html"/>
</head>
<body>
<!-- Google Tag Manager -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WBFQQB6" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager -->  <aside>
    <div>
      <a href="https://evgenypogorelov.com">
        <img src="https://evgenypogorelov.com/images/profile.jpeg" alt="Evgeny Pogorelov" title="Evgeny Pogorelov">
      </a>
      <h1><a href="https://evgenypogorelov.com">Evgeny Pogorelov</a></h1>

<p>Side projects and writings</p>
      <nav>
        <ul class="list">
          <li><a href="https://evgenypogorelov.com/pages/about.html#about">About</a></li>
          <li><a href="https://evgenypogorelov.com/pages/contact.html#contact">Contact</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/evgenypogorelov/en" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/pogoetic" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/pogoetic" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="//pogoetic.github.io/feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://evgenypogorelov.com">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://evgenypogorelov.com/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="portfolio-rebalancing-python">Portfolio Rebalancing Using Python</h1>
    <p>
      Posted on December 17, 2018 in <a href="https://evgenypogorelov.com/category/posts.html">posts</a>

        &#8226; 27 min read
    </p>
  </header>


  <div>
    <style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI escape sequences */
/* The color values are a mix of
   http://www.xcolors.net/dl/baskerville-ivorylight and
   http://www.xcolors.net/dl/euphrasia */
.ansi-black-fg {
  color: #3E424D;
}
.ansi-black-bg {
  background-color: #3E424D;
}
.ansi-black-intense-fg {
  color: #282C36;
}
.ansi-black-intense-bg {
  background-color: #282C36;
}
.ansi-red-fg {
  color: #E75C58;
}
.ansi-red-bg {
  background-color: #E75C58;
}
.ansi-red-intense-fg {
  color: #B22B31;
}
.ansi-red-intense-bg {
  background-color: #B22B31;
}
.ansi-green-fg {
  color: #00A250;
}
.ansi-green-bg {
  background-color: #00A250;
}
.ansi-green-intense-fg {
  color: #007427;
}
.ansi-green-intense-bg {
  background-color: #007427;
}
.ansi-yellow-fg {
  color: #DDB62B;
}
.ansi-yellow-bg {
  background-color: #DDB62B;
}
.ansi-yellow-intense-fg {
  color: #B27D12;
}
.ansi-yellow-intense-bg {
  background-color: #B27D12;
}
.ansi-blue-fg {
  color: #208FFB;
}
.ansi-blue-bg {
  background-color: #208FFB;
}
.ansi-blue-intense-fg {
  color: #0065CA;
}
.ansi-blue-intense-bg {
  background-color: #0065CA;
}
.ansi-magenta-fg {
  color: #D160C4;
}
.ansi-magenta-bg {
  background-color: #D160C4;
}
.ansi-magenta-intense-fg {
  color: #A03196;
}
.ansi-magenta-intense-bg {
  background-color: #A03196;
}
.ansi-cyan-fg {
  color: #60C6C8;
}
.ansi-cyan-bg {
  background-color: #60C6C8;
}
.ansi-cyan-intense-fg {
  color: #258F8F;
}
.ansi-cyan-intense-bg {
  background-color: #258F8F;
}
.ansi-white-fg {
  color: #C5C1B4;
}
.ansi-white-bg {
  background-color: #C5C1B4;
}
.ansi-white-intense-fg {
  color: #A1A6B2;
}
.ansi-white-intense-bg {
  background-color: #A1A6B2;
}
.ansi-default-inverse-fg {
  color: #FFFFFF;
}
.ansi-default-inverse-bg {
  background-color: #000000;
}
.ansi-bold {
  font-weight: bold;
}
.ansi-underline {
  text-decoration: underline;
}
/* The following styles are deprecated an will be removed in a future version */
.ansibold {
  font-weight: bold;
}
.ansi-inverse {
  outline: 0.5px dotted;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  position: relative;
  overflow: visible;
}
div.cell:before {
  position: absolute;
  display: block;
  top: -1px;
  left: -1px;
  width: 5px;
  height: calc(100% +  2px);
  content: '';
  background: transparent;
}
div.cell.jupyter-soft-selected {
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected,
div.cell.selected.jupyter-soft-selected {
  border-color: #ababab;
}
div.cell.selected:before,
div.cell.selected.jupyter-soft-selected:before {
  position: absolute;
  display: block;
  top: -1px;
  left: -1px;
  width: 5px;
  height: calc(100% +  2px);
  content: '';
  background: #42A5F5;
}
@media print {
  div.cell.selected,
  div.cell.selected.jupyter-soft-selected {
    border-color: transparent;
  }
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
}
.edit_mode div.cell.selected:before {
  position: absolute;
  display: block;
  top: -1px;
  left: -1px;
  width: 5px;
  height: calc(100% +  2px);
  content: '';
  background: #66BB6A;
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  /* Note that this should set vertical padding only, since CodeMirror assumes
       that horizontal padding will be set on CodeMirror pre */
  padding: 0.4em 0;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. This sets horizontal padding only,
    use .CodeMirror-lines for vertical */
  padding: 0 0.4em;
  border: 0;
  border-radius: 0;
}
.CodeMirror-cursor {
  border-left: 1.4px solid black;
}
@media screen and (min-width: 2138px) and (max-width: 4319px) {
  .CodeMirror-cursor {
    border-left: 2px solid black;
  }
}
@media screen and (min-width: 4320px) {
  .CodeMirror-cursor {
    border-left: 4px solid black;
  }
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
div.output_area .mglyph > img {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 1px 0 1px 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}
.rendered_html ul:not(.list-inline),
.rendered_html ol:not(.list-inline) {
  padding-left: 2em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}





.rendered_html pre,




.rendered_html tr,
.rendered_html th,


.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,


.rendered_html * + .alert {
  margin-top: 1em;
}
[dir="rtl"] 
div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.rendered .rendered_html tr,
.text_cell.rendered .rendered_html th,
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.text_cell .dropzone .input_area {
  border: 2px dashed #bababa;
  margin: -1px;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you are an investor in stocks or bonds you are likely always looking for ways to increase your return or lower your risk, and it turns out there is a way to do both simultaneously called rebalancing. Portfolio rebalancing is something every investor should either do themselves or have done for them. Registered investment advisors like Vanguard and others will provide this service as part of an active management agreement, while robo-advisors such as Betterment will also rebalance automatically. To understand why it's so important, I'll defer to the finance professionals over at <a href="https://www.bogleheads.org/wiki/Rebalancing">BogleHeads</a> :</p>
<blockquote><p>Rebalancing is the action of bringing a portfolio that has deviated away from one's target asset allocation back into line. The objective is to maintain a consistent mix of asset classes (most commonly equities vs. fixed income) in order to control risk at the level desired by the investor. This is accomplished by transferring funds from higher-performing classes to lower-performing classes. While potentially counterintuitive, rebalancing ensures that investors "Buy Low" and "Sell High".</p>
</blockquote>
<p>Much research has been conducted on the benefits of portoflio rebalancing, here is an excerpt from a fairly recent <a href="https://www.morganstanley.com/articles/rebalancing-effect">Morgan Stanley</a> research piece:</p>
<blockquote><p>Rebalancing takes advantage of the long-term effects of mean reversion. By lightening up on stocks after periods of significant outperformance, or topping off positions after periods of underperformance, this discipline helps take advantage of volatility to benefit from these swings. ... A disciplined approach to rebalancing portfolios annually can create additional return and lower volatility versus never rebalancing or rebalancing during different time periods. While investing for the long term requires patience, a disciplined approach to rebalancing can help create value beyond the cyclical trends of the market.</p>
</blockquote>
<p>Timely and consistent rebalancing has become a cornerstone of modern portfolio theory. Rebalancing can magnify returns by promoting selling high and buying low, and reduce long-term risk by ensuring the portfolio adheres to its designated risk tolerance. The keys are to rebalance in a timely manner (i.e. annually) and to do it consistently because the benefits of rebalancing compound over time - but rebalancing by hand is a pain, and that can lead to inconsistency. I pursued this project due to the lack of free tools to simply rebalance an existing portfolio. Sure, we can all use a worksheet to do the math each time, but why not automate it to make it more likely we will actually do it? Here, inspired by the work of <a href="https://nbviewer.jupyter.org/github/kdboller/pythonsp500/blob/a7066d998ff046c3cc8b26ece3b0efdf00959d57/Investment%20Portfolio%20Python%20Notebook_03_2018_blog%20example.ipynb">kdboller</a>, I'll use Pandas, the Tiingo API, and some simple math to calculate how to optimally rebalance a portfolio given a target allocation. This is a simple, no-frills portfolio rebalancing exercise which does not factor in important considerations such as tax efficiency, transaction costs, minimum investment amounts, or alternate approaches such as stock-out rebalances, or bond-floor settings. Future versions of this project may contemplate these extra factors.</p>
<p>My portfolio is spread across various accounts and asset classes, so at a minimum this portfolio rebalancer had to consider how to best allocate assets within and across accounts. If new assets were added to the portfolio (based on the target portfolio definition) the rebalancer must also handle distributing those new assets into an existing account with adequate funds for it. A final consideration was basic asset tax location, I wanted the distribution of new assets to prioritize the appropriate accounts, for example, bonds will go in tax-free or tax-deferred acounts first and only to taxable accounts as a last resort. The account-level distribution logic is constrained by available funds from sales in that same account, this is a simplifying constraint because the code does not currently contemplate IRA or Roth-IRA contribution levels or limits, and as a practical matter manually moving additional funds into a 401k may be impossible. Unfortunately, these additional considerations add to complexity and code length but I felt leaving them out would be too oversimplified and not actually useful for an average portfolio like my own.</p>
<p>The steps and static code are below, but thanks to the amazing folks over at <a href="https://mybinder.org/">Binder</a> you can run this code interactively right in your browser and play with the rebalancer in real-time and change the inputs to suit your needs. Click the launch Binder link below to launch a new window which will load the code environment (it takes a few minutes).</p>
<p><a href="https://mybinder.org/v2/gh/pogoetic/rebalance/master?filepath=portfolio_rebalance.ipynb" target="_blank"><img src="https://mybinder.org/badge_logo.svg"></a></p>
<p><strong>Steps:</strong></p>
<ol>
<li>Set triggers to rebalance (time or threshold or both)</li>
<li>Define our current Portfolio (accounttype, accountid, lastrebaldate, ticker, shares, cost basis, assetclass)  </li>
<li>Define our target allocation (ticker, allocation, assetclass)  </li>
<li>Factor in any new money being invested  </li>
<li>Aggregate to security level and calculate rebalance triggers to determine which securities must be rebalanced</li>
<li>Calculate initial transactions needed to hit target allocation (1 row per ticker)</li>
<li>Disaggregate portfolio back to account level (1 row per ticker per account)</li>
<li>Iteratively distribute new securities into accounts, keeping tax location in mind</li>
<li>Iteratively distribute across accounts any new securities which do not fit into a single account</li>
</ol>
<p><strong>References:</strong></p>
<p><a href="https://nbviewer.jupyter.org/github/kdboller/pythonsp500/blob/a7066d998ff046c3cc8b26ece3b0efdf00959d57/Investment%20Portfolio%20Python%20Notebook_03_2018_blog%20example.ipynb">pythonsp500 by kdboller</a></p>
<p><a href="https://www.bogleheads.org/wiki/Rebalancing">Portfolio Rebalancing by bogleheads wiki</a></p>
<p><a href="https://www.morganstanley.com/articles/rebalancing-effect">The Rebalancing Effect by Morgan Stanely</a></p>
<p><strong>Github Repo:</strong>
<a href="https://github.com/pogoetic/rebalance">pogoetic/rebalance</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Code">Code<a class="anchor-link" href="#Code">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Lets import the necessary packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">from</span> <span class="nn">pandas_datareader</span> <span class="k">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">pdr</span>
<span class="kn">from</span> <span class="nn">keys</span> <span class="k">import</span> <span class="n">tiingo_key</span>
<span class="c1">#define todays datetime</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Settings</span>
<span class="n">new_money_in</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="c1">#Set our rebalance threshold</span>
<span class="n">rebal_threshold</span> <span class="o">=</span> <span class="o">.</span><span class="mi">05</span> <span class="c1">#allowable allocation drift</span>
<span class="n">rebal_timeframe</span> <span class="o">=</span> <span class="mi">180</span> <span class="c1">#in days</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Define target and current allocations</span>
<span class="c1">#create our target allocation</span>
<span class="n">columns_t</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;allocation_target&#39;</span><span class="p">,</span><span class="s1">&#39;assetclass&#39;</span><span class="p">]</span>
<span class="n">positions_t</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;VTSAX&#39;</span><span class="p">,</span><span class="mf">0.5652</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VIGAX&#39;</span><span class="p">,</span><span class="mf">0.0131</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VSMAX&#39;</span><span class="p">,</span><span class="mf">0.0066</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VSEQX&#39;</span><span class="p">,</span><span class="mf">0.0066</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VWIGX&#39;</span><span class="p">,</span><span class="mf">0.0507</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VTRIX&#39;</span><span class="p">,</span><span class="mf">0.0507</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VTIAX&#39;</span><span class="p">,</span><span class="mf">0.1521</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VBTLX&#39;</span><span class="p">,</span><span class="mf">0.035</span><span class="p">,</span><span class="s1">&#39;BD&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VTABX&#39;</span><span class="p">,</span><span class="mf">0.015</span><span class="p">,</span><span class="s1">&#39;BD&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VGSLX&#39;</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="s1">&#39;RE&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VNQI&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="s1">&#39;RE&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;VDE&#39;</span><span class="p">,</span><span class="mf">0.03</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">],</span>
               <span class="p">[</span><span class="s1">&#39;GLD&#39;</span><span class="p">,</span><span class="mf">0.015</span><span class="p">,</span><span class="s1">&#39;CS&#39;</span><span class="p">]]</span>

<span class="c1">#set our current portfolio</span>
<span class="n">columns_c</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;lastrebaldate&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="s1">&#39;basisdate&#39;</span><span class="p">,</span><span class="s1">&#39;costbasis&#39;</span><span class="p">,</span><span class="s1">&#39;shares&#39;</span><span class="p">]</span>
<span class="n">positions_c</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="s1">&#39;1111&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VBTLX&#39;</span><span class="p">,</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">913.483</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="s1">&#39;1111&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VTIAX&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">514.298</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="s1">&#39;1111&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VTSAX&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mf">151.121</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="s1">&#39;2222&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VBTLX&#39;</span><span class="p">,</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">772.407</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="s1">&#39;2222&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VTSAX&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mf">151.578</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;TAXB&#39;</span><span class="p">,</span><span class="s1">&#39;3333&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;AAPL&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">3.14</span><span class="p">],</span>
             <span class="p">[</span><span class="s1">&#39;TAXB&#39;</span><span class="p">,</span><span class="s1">&#39;3333&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="s1">&#39;VTSAX&#39;</span><span class="p">,</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="s1">&#39;2018-11-16&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mf">549.871</span><span class="p">]]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#lookup table for account type abbreviations</span>
<span class="n">accounttypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TAXB&#39;</span><span class="p">:</span><span class="s1">&#39;Taxable Brokerage&#39;</span><span class="p">,</span> <span class="s1">&#39;401K&#39;</span><span class="p">:</span><span class="s1">&#39;401k&#39;</span><span class="p">,</span> <span class="s1">&#39;RIRA&#39;</span><span class="p">:</span><span class="s1">&#39;Roth-IRA&#39;</span><span class="p">,</span> <span class="s1">&#39;TIRA&#39;</span><span class="p">:</span><span class="s1">&#39;Traditional-IRA&#39;</span><span class="p">}</span>
<span class="n">assetclasses</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ST&#39;</span><span class="p">:</span><span class="s1">&#39;Equity Stocks&#39;</span><span class="p">,</span> <span class="s1">&#39;BD&#39;</span><span class="p">:</span><span class="s1">&#39;Bonds Fixed-Income&#39;</span><span class="p">,</span> <span class="s1">&#39;CS&#39;</span><span class="p">:</span><span class="s1">&#39;Cash and Commodities&#39;</span><span class="p">,</span> <span class="s1">&#39;RE&#39;</span><span class="p">:</span><span class="s1">&#39;Real-Estate&#39;</span><span class="p">,</span> <span class="s1">&#39;ALT&#39;</span><span class="p">:</span><span class="s1">&#39;Alternatives&#39;</span><span class="p">}</span>
<span class="n">assettypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SEC&#39;</span><span class="p">:</span><span class="s1">&#39;Individual Security&#39;</span><span class="p">,</span> <span class="s1">&#39;ETF&#39;</span><span class="p">:</span><span class="s1">&#39;Exchange Traded Fund&#39;</span><span class="p">,</span> <span class="s1">&#39;MF&#39;</span><span class="p">:</span> <span class="s1">&#39;Mutual Fund&#39;</span><span class="p">,</span> <span class="s1">&#39;IF&#39;</span><span class="p">:</span><span class="s1">&#39;Index Fund&#39;</span><span class="p">}</span>
<span class="n">assetregion</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;D&#39;</span><span class="p">:</span><span class="s1">&#39;Domestic&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="s1">&#39;International&#39;</span><span class="p">}</span>

<span class="c1">#initialize target portfolio</span>
<span class="n">targetalloc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_t</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">positions_t</span><span class="p">)</span>
<span class="n">total</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">targetalloc</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="c1">#check that our target allocation indeed adds to 100%</span>
<span class="k">assert</span> <span class="nb">round</span><span class="p">(</span><span class="n">total</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Target Allocation not 100% : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>

<span class="c1">#initialize current portfolio</span>
<span class="n">start_port</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns_c</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">positions_c</span><span class="p">)</span>
<span class="n">start_port</span><span class="o">.</span><span class="n">lastrebaldate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_port</span><span class="o">.</span><span class="n">lastrebaldate</span><span class="p">)</span>
<span class="n">start_port</span><span class="o">.</span><span class="n">basisdate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_port</span><span class="o">.</span><span class="n">basisdate</span><span class="p">)</span>

<span class="c1">#custom apply function</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;lastrebaldate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lastrebaldate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;assetclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;assetclass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;basisdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;basisdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;costbasis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;costbasis&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;shares&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;shares&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#weighted avg</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;shares&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lastrebaldate&#39;</span><span class="p">,</span> <span class="s1">&#39;assetclass&#39;</span><span class="p">,</span> <span class="s1">&#39;basisdate&#39;</span><span class="p">,</span> <span class="s1">&#39;costbasis&#39;</span><span class="p">,</span> <span class="s1">&#39;shares&#39;</span><span class="p">])</span>

<span class="c1">#aggregate by ticker to account for duplicate securities held in different accounts</span>
<span class="n">agg_port</span> <span class="o">=</span> <span class="n">start_port</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ticker&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1">#Define list of distinct tickers we care about</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">targetalloc</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="n">start_port</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Lets look at our input portfolios (target and current)</span>
<span class="n">display</span><span class="p">(</span><span class="n">targetalloc</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">start_port</span><span class="p">)</span>

<span class="c1">#And our aggregated portfolio at the ticker level (1 row per ticker)</span>
<span class="n">display</span><span class="p">(</span><span class="n">agg_port</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>allocation_target</th>
      <th>assetclass</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>VTSAX</td>
      <td>0.5652</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>1</th>
      <td>VIGAX</td>
      <td>0.0131</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>2</th>
      <td>VSMAX</td>
      <td>0.0066</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>3</th>
      <td>VSEQX</td>
      <td>0.0066</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>4</th>
      <td>VWIGX</td>
      <td>0.0507</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>5</th>
      <td>VTRIX</td>
      <td>0.0507</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>6</th>
      <td>VTIAX</td>
      <td>0.1521</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>7</th>
      <td>VBTLX</td>
      <td>0.0350</td>
      <td>BD</td>
    </tr>
    <tr>
      <th>8</th>
      <td>VTABX</td>
      <td>0.0150</td>
      <td>BD</td>
    </tr>
    <tr>
      <th>9</th>
      <td>VGSLX</td>
      <td>0.0500</td>
      <td>RE</td>
    </tr>
    <tr>
      <th>10</th>
      <td>VNQI</td>
      <td>0.0100</td>
      <td>RE</td>
    </tr>
    <tr>
      <th>11</th>
      <td>VDE</td>
      <td>0.0300</td>
      <td>ST</td>
    </tr>
    <tr>
      <th>12</th>
      <td>GLD</td>
      <td>0.0150</td>
      <td>CS</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accounttype</th>
      <th>accountid</th>
      <th>lastrebaldate</th>
      <th>ticker</th>
      <th>assetclass</th>
      <th>basisdate</th>
      <th>costbasis</th>
      <th>shares</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>2018-11-16</td>
      <td>VBTLX</td>
      <td>BD</td>
      <td>2018-11-16</td>
      <td>1</td>
      <td>913.483</td>
    </tr>
    <tr>
      <th>1</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>2018-11-16</td>
      <td>VTIAX</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1</td>
      <td>514.298</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>2018-11-16</td>
      <td>VTSAX</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>10</td>
      <td>151.121</td>
    </tr>
    <tr>
      <th>3</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>2018-11-16</td>
      <td>VBTLX</td>
      <td>BD</td>
      <td>2018-11-16</td>
      <td>1</td>
      <td>772.407</td>
    </tr>
    <tr>
      <th>4</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>2018-11-16</td>
      <td>VTSAX</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>20</td>
      <td>151.578</td>
    </tr>
    <tr>
      <th>5</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>2018-11-16</td>
      <td>AAPL</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1</td>
      <td>3.140</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>2018-11-16</td>
      <td>VTSAX</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>10</td>
      <td>549.871</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lastrebaldate</th>
      <th>assetclass</th>
      <th>basisdate</th>
      <th>costbasis</th>
      <th>shares</th>
    </tr>
    <tr>
      <th>ticker</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AAPL</th>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>3.140</td>
    </tr>
    <tr>
      <th>VBTLX</th>
      <td>2018-11-16</td>
      <td>BD</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>1685.890</td>
    </tr>
    <tr>
      <th>VTIAX</th>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>514.298</td>
    </tr>
    <tr>
      <th>VTSAX</th>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>11.777895</td>
      <td>852.570</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Next we pull the latest prices from Tiingo (YahooFinance is buggy, and IEX does not contain mutual fund data)</span>
<span class="c1">#Tiingo limits for free API: 500 unique tickers ever, 500 requests/hr, 20,000 requests/day</span>
<span class="c1">#https://pandas-datareader.readthedocs.io/en/latest/remote_data.html#tiingo</span>
<span class="c1">#Tiingo API key required: set &#39;tiingo_key&#39; value in python file called &#39;keys.py&#39; in same directory as this script</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">yesterday</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#avoids weekends with no data - need better weekend detection</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">yesterday</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">yesterday</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>

<span class="n">bad_tickers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickers</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">ohlc</span> <span class="o">=</span> <span class="n">pdr</span><span class="o">.</span><span class="n">get_data_tiingo</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">tiingo_key</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">close</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ohlc</span> <span class="o">=</span> <span class="n">ohlc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdr</span><span class="o">.</span><span class="n">get_data_tiingo</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">tiingo_key</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">bad_tickers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        
<span class="c1">#print(bad_tickers)</span>
<span class="n">ohlc</span> <span class="o">=</span> <span class="n">ohlc</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

<span class="c1">#drop our date index since its only the latest data</span>
<span class="n">ohlc2</span><span class="o">=</span><span class="n">ohlc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Manual fix for known bad_tickers which Tiingo can&#39;t find, adjust to suit your needs</span>
<span class="k">if</span> <span class="s1">&#39;VMFXX&#39;</span> <span class="ow">in</span> <span class="n">bad_tickers</span><span class="p">:</span>
    <span class="n">ohlc2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VMFXX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#What did we get?</span>
<span class="n">display</span><span class="p">(</span><span class="n">ohlc2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
    </tr>
    <tr>
      <th>symbol</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>VTABX</th>
      <td>21.66</td>
    </tr>
    <tr>
      <th>VIGAX</th>
      <td>68.02</td>
    </tr>
    <tr>
      <th>VSEQX</th>
      <td>26.77</td>
    </tr>
    <tr>
      <th>VTIAX</th>
      <td>25.17</td>
    </tr>
    <tr>
      <th>VNQI</th>
      <td>52.05</td>
    </tr>
    <tr>
      <th>VWIGX</th>
      <td>24.76</td>
    </tr>
    <tr>
      <th>VTSAX</th>
      <td>61.08</td>
    </tr>
    <tr>
      <th>VTRIX</th>
      <td>31.91</td>
    </tr>
    <tr>
      <th>VBTLX</th>
      <td>10.39</td>
    </tr>
    <tr>
      <th>VDE</th>
      <td>77.44</td>
    </tr>
    <tr>
      <th>VSMAX</th>
      <td>62.25</td>
    </tr>
    <tr>
      <th>AAPL</th>
      <td>156.15</td>
    </tr>
    <tr>
      <th>VGSLX</th>
      <td>105.06</td>
    </tr>
    <tr>
      <th>GLD</th>
      <td>120.57</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#concatenate target allocation and latest prices with our portfolio</span>
<span class="n">start_port_c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">agg_port</span><span class="p">,</span> <span class="n">targetalloc</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
<span class="n">final_port</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">start_port_c</span><span class="p">,</span> <span class="n">ohlc2</span><span class="p">,</span> <span class="n">left_on</span> <span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>

<span class="c1">#set target to zero for tickers held but not present in our target allocation, set initial basisdate and costbasis for new securities entering the portfolio</span>
<span class="n">final_port</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;allocation_target&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;shares&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;basisdate&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)),</span><span class="s1">&#39;costbasis&#39;</span><span class="p">:</span><span class="n">final_port</span><span class="o">.</span><span class="n">close</span><span class="p">,</span><span class="s1">&#39;assetclass_x&#39;</span><span class="p">:</span><span class="n">final_port</span><span class="o">.</span><span class="n">assetclass_y</span><span class="p">},</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">final_port</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;assetclass_y&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">final_port</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;assetclass_x&#39;</span><span class="p">:</span><span class="s1">&#39;assetclass&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#calculate holding values and current allocation</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_port</span><span class="o">.</span><span class="n">close</span> <span class="o">*</span> <span class="n">final_port</span><span class="o">.</span><span class="n">shares</span> <span class="c1">#calculate value as price x shares</span>
<span class="n">final_port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">final_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">final_port</span><span class="o">.</span><span class="n">shares</span><span class="o">.</span><span class="n">isna</span><span class="p">(),[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">=</span><span class="mf">0.0</span> <span class="c1">#for securities not currently held but in our target (and close price failed to return), establish zero value</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_port</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">final_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_port</span><span class="o">.</span><span class="n">allocation_target</span> <span class="o">-</span> <span class="n">final_port</span><span class="o">.</span><span class="n">allocation</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;new_money_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_money_in</span> <span class="o">*</span> <span class="n">final_port</span><span class="o">.</span><span class="n">allocation_target</span> <span class="c1">#Account for new money in</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#create timedelta int column</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">lastrebaldate</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
<span class="n">final_port</span><span class="o">.</span><span class="n">timedelta</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#define rebalance flags to determine if we must rebalance</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;rebal_flag_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">rebal_threshold</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">allocation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;rebal_flag_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">timedelta</span> <span class="o">&gt;=</span> <span class="n">rebal_timeframe</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;rebal_flag_exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">final_port</span><span class="o">.</span><span class="n">allocation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#force rebal securities not present in our target portfolio</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;rebal_flag_newmoney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">new_money_in</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">final_port</span><span class="p">[</span><span class="s1">&#39;rebal_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag_thresh</span> <span class="o">+</span> <span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag_time</span> <span class="o">+</span> <span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag_exit</span> <span class="o">+</span> <span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag_newmoney</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Subset of securities we need to rebalance, and those we need to leave alone</span>
<span class="n">rebal_port</span> <span class="o">=</span> <span class="n">final_port</span><span class="p">[</span><span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stable_port</span> <span class="o">=</span> <span class="n">final_port</span><span class="p">[</span><span class="n">final_port</span><span class="o">.</span><span class="n">rebal_flag</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Calculate our current allocation, target, and the change we need to hit target</span>
<span class="n">total_val</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;allocation_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">/</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">allocation_target</span> <span class="o">-</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">allocation</span>

<span class="c1">#Factor in any new money entering the portfolio and determine necessary changes in value and shares</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;value_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_val</span> <span class="o">*</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span> <span class="o">+</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">new_money_in</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;shares_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">value_chg</span> <span class="o">/</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">close</span>
<span class="n">rebal_port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">value_chg</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">shares</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,[</span><span class="s1">&#39;shares_chg&#39;</span><span class="p">]]</span><span class="o">=-</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">shares</span> <span class="c1">#sell all shares of securities not in our target portfolio</span>

<span class="c1">#Round off shares to whole numbers, except when we are fully exiting a position</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;shares_chg_round&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">shares_chg</span>
<span class="n">rebal_port</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;shares_chg_round&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">shares_chg</span>
<span class="n">rebal_port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">shares_chg</span><span class="o">+</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">shares</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">,[</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">shares_chg_round</span><span class="o">*</span><span class="mf">1.0</span>
<span class="n">rebal_port</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;shares_chg_round&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Calculate initial new shares and values</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;new_shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">shares</span> <span class="o">+</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">final_shares_chg</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;new_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">new_shares</span> <span class="o">*</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">close</span> <span class="c1">#due to share rounding, there will be slight variance vs. portfolio starting value</span>
<span class="n">rebal_port</span><span class="p">[</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">final_shares_chg</span> <span class="o">*</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">close</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Double check our work so far</span>
<span class="c1">#net of buying and selling should be zero</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">value_chg</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">new_money_in</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> 
<span class="c1">#make sure totals match (with rounding error + new money in) from original portfolio and rebalanced portfolio</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">new_value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">rebal_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">rebal_port</span><span class="o">.</span><span class="n">new_value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">stable_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">-</span> <span class="n">final_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">3</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Merge our rebalanced portfolio with our stable portfolio for our execution portfolio</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;value_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;shares_chg&#39;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;new_shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stable_port</span><span class="o">.</span><span class="n">shares</span>
<span class="n">stable_port</span><span class="p">[</span><span class="s1">&#39;new_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stable_port</span><span class="o">.</span><span class="n">value</span>
<span class="n">exec_port</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rebal_port</span><span class="p">,</span><span class="n">stable_port</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">exec_port</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span><span class="s1">&#39;rebal_flag_thresh&#39;</span><span class="p">,</span><span class="s1">&#39;rebal_flag_time&#39;</span><span class="p">,</span><span class="s1">&#39;rebal_flag_exit&#39;</span><span class="p">,</span><span class="s1">&#39;rebal_flag_newmoney&#39;</span><span class="p">,</span><span class="s1">&#39;value_chg&#39;</span><span class="p">,</span><span class="s1">&#39;shares_chg&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Reset allocations to be based on all securities</span>
<span class="n">exec_port</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">exec_port</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">exec_port</span><span class="p">[</span><span class="s1">&#39;allocation_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">/</span><span class="n">exec_port</span><span class="o">.</span><span class="n">allocation_target</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">exec_port</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">allocation_target</span> <span class="o">-</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">allocation</span>
<span class="n">exec_port</span><span class="p">[</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">new_value</span> <span class="o">/</span> <span class="n">exec_port</span><span class="o">.</span><span class="n">new_value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Lets look at all our work to get to our target portfolio</span>
<span class="n">exec_port</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[14]:</div>



<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ticker</th>
      <th>lastrebaldate</th>
      <th>assetclass</th>
      <th>basisdate</th>
      <th>costbasis</th>
      <th>shares</th>
      <th>allocation_target</th>
      <th>close</th>
      <th>value</th>
      <th>allocation</th>
      <th>correction</th>
      <th>new_money_in</th>
      <th>rebal_flag</th>
      <th>final_shares_chg</th>
      <th>new_shares</th>
      <th>new_value</th>
      <th>new_value_chg</th>
      <th>final_allocation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>AAPL</td>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>3.140</td>
      <td>0.0000</td>
      <td>156.15</td>
      <td>490.31100</td>
      <td>0.005905</td>
      <td>-0.005905</td>
      <td>0.0</td>
      <td>1</td>
      <td>-3.14</td>
      <td>0.000</td>
      <td>0.00000</td>
      <td>-490.311</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>VBTLX</td>
      <td>2018-11-16</td>
      <td>BD</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>1685.890</td>
      <td>0.0350</td>
      <td>10.39</td>
      <td>17516.39710</td>
      <td>0.210973</td>
      <td>-0.175973</td>
      <td>350.0</td>
      <td>1</td>
      <td>-1372.00</td>
      <td>313.890</td>
      <td>3261.31710</td>
      <td>-14255.080</td>
      <td>0.035196</td>
    </tr>
    <tr>
      <th>2</th>
      <td>VTIAX</td>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>1.000000</td>
      <td>514.298</td>
      <td>0.1521</td>
      <td>25.17</td>
      <td>12944.88066</td>
      <td>0.155913</td>
      <td>-0.003813</td>
      <td>1521.0</td>
      <td>1</td>
      <td>47.00</td>
      <td>561.298</td>
      <td>14127.87066</td>
      <td>1182.990</td>
      <td>0.152468</td>
    </tr>
    <tr>
      <th>3</th>
      <td>VTSAX</td>
      <td>2018-11-16</td>
      <td>ST</td>
      <td>2018-11-16</td>
      <td>11.777895</td>
      <td>852.570</td>
      <td>0.5652</td>
      <td>61.08</td>
      <td>52074.97560</td>
      <td>0.627209</td>
      <td>-0.062009</td>
      <td>5652.0</td>
      <td>1</td>
      <td>8.00</td>
      <td>860.570</td>
      <td>52563.61560</td>
      <td>488.640</td>
      <td>0.567266</td>
    </tr>
    <tr>
      <th>4</th>
      <td>VIGAX</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>68.020000</td>
      <td>0.000</td>
      <td>0.0131</td>
      <td>68.02</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.013100</td>
      <td>131.0</td>
      <td>1</td>
      <td>17.00</td>
      <td>17.000</td>
      <td>1156.34000</td>
      <td>1156.340</td>
      <td>0.012479</td>
    </tr>
    <tr>
      <th>5</th>
      <td>VSMAX</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>62.250000</td>
      <td>0.000</td>
      <td>0.0066</td>
      <td>62.25</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.006600</td>
      <td>66.0</td>
      <td>1</td>
      <td>9.00</td>
      <td>9.000</td>
      <td>560.25000</td>
      <td>560.250</td>
      <td>0.006046</td>
    </tr>
    <tr>
      <th>6</th>
      <td>VSEQX</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>26.770000</td>
      <td>0.000</td>
      <td>0.0066</td>
      <td>26.77</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.006600</td>
      <td>66.0</td>
      <td>1</td>
      <td>22.00</td>
      <td>22.000</td>
      <td>588.94000</td>
      <td>588.940</td>
      <td>0.006356</td>
    </tr>
    <tr>
      <th>7</th>
      <td>VWIGX</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>24.760000</td>
      <td>0.000</td>
      <td>0.0507</td>
      <td>24.76</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.050700</td>
      <td>507.0</td>
      <td>1</td>
      <td>190.00</td>
      <td>190.000</td>
      <td>4704.40000</td>
      <td>4704.400</td>
      <td>0.050770</td>
    </tr>
    <tr>
      <th>8</th>
      <td>VTRIX</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>31.910000</td>
      <td>0.000</td>
      <td>0.0507</td>
      <td>31.91</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.050700</td>
      <td>507.0</td>
      <td>1</td>
      <td>147.00</td>
      <td>147.000</td>
      <td>4690.77000</td>
      <td>4690.770</td>
      <td>0.050623</td>
    </tr>
    <tr>
      <th>9</th>
      <td>VTABX</td>
      <td>NaT</td>
      <td>BD</td>
      <td>2018-12-27</td>
      <td>21.660000</td>
      <td>0.000</td>
      <td>0.0150</td>
      <td>21.66</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.015000</td>
      <td>150.0</td>
      <td>1</td>
      <td>64.00</td>
      <td>64.000</td>
      <td>1386.24000</td>
      <td>1386.240</td>
      <td>0.014960</td>
    </tr>
    <tr>
      <th>10</th>
      <td>VGSLX</td>
      <td>NaT</td>
      <td>RE</td>
      <td>2018-12-27</td>
      <td>105.060000</td>
      <td>0.000</td>
      <td>0.0500</td>
      <td>105.06</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.050000</td>
      <td>500.0</td>
      <td>1</td>
      <td>44.00</td>
      <td>44.000</td>
      <td>4622.64000</td>
      <td>4622.640</td>
      <td>0.049887</td>
    </tr>
    <tr>
      <th>11</th>
      <td>VNQI</td>
      <td>NaT</td>
      <td>RE</td>
      <td>2018-12-27</td>
      <td>52.050000</td>
      <td>0.000</td>
      <td>0.0100</td>
      <td>52.05</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.010000</td>
      <td>100.0</td>
      <td>1</td>
      <td>17.00</td>
      <td>17.000</td>
      <td>884.85000</td>
      <td>884.850</td>
      <td>0.009549</td>
    </tr>
    <tr>
      <th>12</th>
      <td>VDE</td>
      <td>NaT</td>
      <td>ST</td>
      <td>2018-12-27</td>
      <td>77.440000</td>
      <td>0.000</td>
      <td>0.0300</td>
      <td>77.44</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.030000</td>
      <td>300.0</td>
      <td>1</td>
      <td>36.00</td>
      <td>36.000</td>
      <td>2787.84000</td>
      <td>2787.840</td>
      <td>0.030086</td>
    </tr>
    <tr>
      <th>13</th>
      <td>GLD</td>
      <td>NaT</td>
      <td>CS</td>
      <td>2018-12-27</td>
      <td>120.570000</td>
      <td>0.000</td>
      <td>0.0150</td>
      <td>120.57</td>
      <td>0.00000</td>
      <td>0.000000</td>
      <td>0.015000</td>
      <td>150.0</td>
      <td>1</td>
      <td>11.00</td>
      <td>11.000</td>
      <td>1326.27000</td>
      <td>1326.270</td>
      <td>0.014313</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Lets add a bar chart here to show the new allocation vs. the target allocation and vs. the original portfolio</span>
<span class="n">graph_port</span> <span class="o">=</span> <span class="n">exec_port</span><span class="p">[[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;allocation&#39;</span><span class="p">,</span><span class="s1">&#39;allocation_target&#39;</span><span class="p">,</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">graph_port</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[16]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x12561aa20&gt;</pre>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>




<div class="output_png output_subarea ">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABKYAAAJCCAYAAAD6G89IAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADl0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uIDMuMC4wLCBodHRwOi8vbWF0cGxvdGxpYi5vcmcvqOYd8AAAIABJREFUeJzs3Xu0XlV9L/zvDxJIIhwFQWvUGtSDINm5sSkRK4KgpYoUUTTIWxM8QhHxUiuVWqs51IoCFcUiFBShlpODJy+kaIcHC5KDlItsMBACiCIppvJ6ICiCIVx0vn/sJ3EbcyV7Z8Xk8xljj/2sueac6zd3Rv75jrnmU621AAAAAMCmtk3XBQAAAACwdRJMAQAAANAJwRQAAAAAnRBMAQAAANAJwRQAAAAAnRBMAQAAANAJwRQAAAAAnRBMAQAAANAJwRQAAAAAnRjVdQFd22WXXdqECRO6LgMAAABgi3HzzTc/2FrbdV39tvpgasKECRkYGOi6DAAAAIAtRlX9x/r08yofAAAAAJ0QTAEAAADQCcEUAAAAAJ3Y6s+YAgAAAEbWk08+mSVLlmT58uVdl8IwGzNmTF7wghdk9OjRT2u8YAoAAAAYUUuWLMmOO+6YCRMmpKq6Lodh0lrL0qVLs2TJkuy2225Paw6v8gEAAAAjavny5Xn2s58tlNrCVFWe/exnb9ROOMEUAAAAMOKEUlumjf13FUwBAAAA0Imt/oypRUsXpe+ivhGbf+HMhSM2NwAAAPwumnDyvw7rfIs/9YanV8eECRkYGMguu+ySHXbYIY8++uiw1TRv3rzsvvvuefnLX54k+djHPpb9998/Bx988LA9Y0tgxxQAAADAMJs3b17uuOOOldennHKKUGo1BFMAAADAFu/www/P3nvvnb322ivnnXfeGvu11nLSSSdl4sSJ6evryyWXXLLy3mmnnZa+vr5Mnjw5J598cpLk/PPPzz777JPJkyfnzW9+c5YtW5brrrsul19+eU466aRMmTIl99xzT2bNmpW5c+cmSa666qpMnTo1fX19eec735nHH388yeAOro9//OOZNm1a+vr6ctddd43gX2TzIJgCAAAAtngXXHBBbr755gwMDOSss87K0qVLV9vv0ksvzYIFC3LrrbfmyiuvzEknnZT7778/3/jGNzJv3rzceOONufXWW/OXf/mXSZIjjjgiN910U2699dbsueee+dKXvpT99tsvhx12WE4//fQsWLAgL3nJS1bOv3z58syaNSuXXHJJFi5cmKeeeirnnHPOyvu77LJLbrnllrz73e/OGWecMbJ/lM2AYAoAAADY4p111lmZPHlypk+fnh/96Ef5/ve/v9p+1157bY466qhsu+22ee5zn5tXv/rVuemmm3LllVfmmGOOybhx45IkO++8c5Lk9ttvz6te9ar09fXl4osvzqJFi9Zax/e+973stttu2X333ZMkM2fOzDXXXLPy/hFHHJEk2XvvvbN48eKNXfZmb6s//BwAAADYss2fPz9XXnllrr/++owbNy4HHHBAli9fvtq+rbU1tlfVb7XPmjUr8+bNy+TJk3PhhRdm/vz5a61lTfOvsP322ydJtt122zz11FNr7bsl2CyDqap6bpIzk0xP8tMkTyQ5rff5Q621Q1fpPz/J85I8nmS7JFcm+Whr7WfretZejz+RgXvvG9b6f8PsZyazHx65+QEAAIC1evjhh7PTTjtl3Lhxueuuu3LDDTesse/++++ff/zHf8zMmTPz0EMP5Zprrsnpp5+e7bbbLqecckre/va3Z9y4cXnooYey884755FHHsnznve8PPnkk7n44ovz/Oc/P0my44475pFHHvmt+ffYY48sXrw4P/jBD/LSl740X/nKV/LqV796xNa+udvsgqkajB/nJbmotfb2XtuLkhyWwWBqTY5urQ1U1XZJTk3yL0m23n9ZAAAA2Ewt/tQbNunzDjnkkJx77rmZNGlSXvayl2X69Olr7PumN70p119/fSZPnpyqymmnnZbf+73fyyGHHJIFCxakv78/2223XV7/+tfnk5/8ZP72b/82++67b170ohelr69vZRg1Y8aMHHvssTnrrLNWHnqeJGPGjMmXv/zlHHnkkXnqqaeyzz775Pjjjx/xv8Hmqta1hWxTq6qDknystfZboVJVHZA175j6UGttoHe9bZIfJDm8tXbr2p7XP37bNnDcDsNU/RrYMQUAAMBW7M4778yee+7ZdRmMkNX9+1bVza21/nWN3RwPP98ryS0bM0Fr7ZdJbk2yx7BUBAAAAMCw2xyDqd9QVWdX1a1VddOGDl3LnMdV1UBVDTywbPPaMQYAAACwtdgcg6lFSaatuGitvSfJQUl2Xd8Jeq/y9SW5c3X3W2vntdb6W2v9u45bY34FAAAAwAjaHIOpbyUZU1XvHtI2bn0HV9XoDB5+/qPW2m3DXRwAAAAAw2Oz+1a+1lqrqsOTnFlVf5nkgSS/SPLhXpeDqmrJkCFH9n5fXFWPJ9k+yZVJ/mS9Hjh+ajJ7YFhqBwAAAGD9bXbBVJK01u5PMmMNt8eupu2AkasGAAAAgJGwWQZTAAAAwBZs9jOHeb6Hh3c+NpnN8YwpAAAAgBE3YcKEPPjgg0mSHXbYYVjnnjdvXu64446V1x/72Mdy5ZVXDtv88+fPz3XXXTds863NZz/72SxbtmxE5hZMAQAAAAyzVYOpU045JQcffPCwzf90gqmnnnrqaT1LMAUAAACwEQ4//PDsvffe2WuvvXLeeeetsV9rLSeddFImTpyYvr6+XHLJJSvvnXbaaenr68vkyZNz8sknJ0nOP//87LPPPpk8eXLe/OY3Z9myZbnuuuty+eWX56STTsqUKVNyzz33ZNasWZk7d26S5KqrrsrUqVPT19eXd77znXn88ceTDO7g+vjHP55p06alr68vd91112prXLx4cc4999yceeaZmTJlSr797W/na1/7Wvbdd99MnTo1Bx98cH7yk58kSWbPnp3jjjsur3vd6/KOd7wjy5Yty1vf+tZMmjQpb3vb27LvvvtmYGDwS+G++c1v5hWveEWmTZuWI488Mo8++mjOOuus/PjHP86BBx6YAw88cOP/IVbhjCkAAABgi3fBBRdk5513zmOPPZZ99tknb37zm1fb79JLL82CBQty66235sEHH8w+++yT/fffPwsWLMi8efNy4403Zty4cXnooYeSJEcccUSOPfbYJMlHP/rRfOlLX8p73/veHHbYYTn00EPzlre85TfmX758eWbNmpWrrroqu+++e97xjnfknHPOyQc+8IEkyS677JJbbrklX/jCF3LGGWfki1/84m/VOGHChBx//PHZYYcd8qEPfShJ8tOf/jQ33HBDqipf/OIXc9ppp+Xv//7vkyQ333xzrr322owdOzZnnHFGdtppp9x22225/fbbM2XKlCTJgw8+mE984hO58sor84xnPCOf/vSn85nPfCYf+9jH8pnPfCZXX311dtlll2H4l/hNgikAAABgi3fWWWflsssuS5L86Ec/yve///3V9rv22mtz1FFHZdttt81zn/vcvPrVr85NN92U//N//k+OOeaYjBs3Lkmy8847J0luv/32fPSjH83PfvazPProo/mjP/qjtdbxve99L7vttlt23333JMnMmTNz9tlnrwymjjjiiCTJ3nvvnUsvvXS917dkyZK87W1vy/33358nnngiu+2228p7hx12WMaOHbtyfe9///uTJBMnTsykSZOSJDfccEPuuOOOvPKVr0ySPPHEE3nFK16x3s9/ugRTAAAAwBZt/vz5ufLKK3P99ddn3LhxOeCAA7J8+fLV9m2trbG9qn6rfdasWZk3b14mT56cCy+8MPPnz19rLWuaf4Xtt98+SbLttttu0JlQ733ve/PBD34whx12WObPn5/Zs2evvPeMZzxjnc9vreW1r31t5syZs97PHA6CKQAAAGDTmv3wJn3cww8/nJ122injxo3LXXfdlRtuuGGNfffff//84z/+Y2bOnJmHHnoo11xzTU4//fRst912OeWUU/L2t7995at8O++8cx555JE873nPy5NPPpmLL744z3/+85MkO+64Yx555JHfmn+PPfbI4sWL84Mf/CAvfelL85WvfCWvfvWrN3hNO+64Y37+85//xhpXPPuiiy5a47g//MM/zFe/+tUceOCBueOOO7Jw4cIkyfTp0/Oe97xnZV3Lli3LkiVLsvvuu69cy0i8yufwcwAAAGCLdsghh+Spp57KpEmT8jd/8zeZPn36Gvu+6U1vyqRJkzJ58uS85jWvyWmnnZbf+73fyyGHHJLDDjss/f39mTJlSs4444wkyd/+7d9m3333zWtf+9rsscceK+eZMWNGTj/99EydOjX33HPPyvYxY8bky1/+co488sj09fVlm222yfHHH7/Ba3rjG9+Yyy67bOXh57Nnz86RRx6ZV73qVWsNkE444YQ88MADmTRpUj796U9n0qRJeeYzn5ldd901F154YY466qhMmjQp06dPX3n4+nHHHZc//uM/HpHDz2tdW8i2dP39/W3F6fMAAADA8Lvzzjuz5557dl0GSX75y1/mySefzJgxY3LPPffkoIMOyt13353tttvuac+5un/fqrq5tda/rrFe5QMAAADYSixbtiwHHnhgnnzyybTWcs4552xUKLWxBFMAAAAAm6kvf/nL+dznPvcbba985Stz9tlnP635dtxxx2xOb44JpgAAAAA2U8ccc0yOOeaYrssYMQ4/BwAAAKATgikAAAAAOiGYAgAAAKATzpgCAAAANqm+i/qGdb6FMxcO63xsOnZMAQAAAFu8s846K3vuuWd22mmnfOpTn3ra8+ywww4bNW7x4sWZOHHi037+6lx44YX58Y9/vPL6Xe96V+64445hfcZIsWMKAAAA2OJ94QtfyDe+8Y3stttuXZcy7C688MJMnDgx48ePT5J88Ytf7Lii9WfHFAAAALBFO/744/PDH/4whx12WM4888yceOKJSZJZs2blfe97X/bbb7+8+MUvzty5c5Mkjz76aA466KBMmzYtfX19+Zd/+Zf1es6Gjlu+fHmOOeaY9PX1ZerUqbn66quTJL/85S/zoQ99KH19fZk0aVI+//nPJ0lOOeWU7LPPPpk4cWKOO+64tNYyd+7cDAwM5Oijj86UKVPy2GOP5YADDsjAwECSZM6cOenr68vEiRPz4Q9/eOWzd9hhh/z1X/91Jk+enOnTp+cnP/nJhv1Rh4lgCgAAANiinXvuuRk/fnyuvvrq7LTTTr9x7/7778+1116br3/96zn55JOTJGPGjMlll12WW265JVdffXX+4i/+Iq21dT5nQ8edffbZSZKFCxdmzpw5mTlzZpYvX57zzjsv9957b7773e/mtttuy9FHH50kOfHEE3PTTTfl9ttvz2OPPZavf/3rectb3pL+/v5cfPHFWbBgQcaOHbty/h//+Mf58Ic/nG9961tZsGBBbrrppsybNy9J8otf/CLTp0/Prbfemv333z/nn3/+hv1Rh4lgCgAAANhqHX744dlmm23y8pe/fOWuodZaPvKRj2TSpEk5+OCD85//+Z/rtaNoQ8dde+21+dM//dMkyR577JEXvehFufvuu3PllVfm+OOPz6hRgycw7bzzzkmSq6++Ovvuu2/6+vryrW99K4sWLVprPTfddFMOOOCA7Lrrrhk1alSOPvroXHPNNUmS7bbbLoceemiSZO+9987ixYvXub6R4IwpAAAAYKu1/fbbr/y8YnfTxRdfnAceeCA333xzRo8enQkTJmT58uXrnGtDx61pN1VrLVX1G23Lly/PCSeckIGBgbzwhS/M7Nmz11nT2nZrjR49euUztt122zz11FNrnWukCKYAAACATWrhzIVdl7BWDz/8cJ7znOdk9OjRufrqq/Mf//EfIzJu//33z8UXX5zXvOY1ufvuu3PfffflZS97WV73utfl3HPPzQEHHJBRo0bloYceyjbbDL70tssuu+TRRx/N3Llz85a3vCVJsuOOO+aRRx75rfn33XffvP/978+DDz6YnXbaKXPmzMl73/veDfxrjKytPphatHRR+i7q67qMYbG5/8cGAACA3wVHH3103vjGN6a/vz9TpkzJHnvsMSLjTjjhhBx//PHp6+vLqFGjcuGFF2b77bfPu971rtx9992ZNGlSRo8enWOPPTYnnnhijj322PT19WXChAnZZ599Vs4za9asHH/88Rk7dmyuv/76le3Pe97zcuqpp+bAAw9May2vf/3r8yd/8idP748yQmp9Du/ako3dbWx76eyXdl3GsBBMAQAAsDm68847s+eee3ZdBiNkdf++VXVza61/XWMdfg4AAABAJ7b6V/kAAAAANsTChQtXfpveCttvv31uvPHGjir63SWYAgAAAEbc6r5p7ndVX19fFixY0HUZm4WNPSLKq3wAAADAiBozZkyWLl260SEGm5fWWpYuXZoxY8Y87Tk2ux1TVTU/yamttSuGtH0gyeuSHJjkriRjkjyS5OzW2kW9PrOSnJ7kP4dM9/bW2h1re95ejz+RgXvvG84lAAAAAEO84AUvyJIlS/LAAw90XQrDbMyYMXnBC17wtMdvdsFUkjlJZiS5YkjbjCQnJfn91trUJKmqFye5tKq2aa19udfvktbaiZu0WgAAAGCtRo8end12263rMtgMbY6v8s1NcmhVbZ8kVTUhyfgkS4Z2aq39MMkHk7xvE9cHAAAAwDDY7IKp1trSJN9JckivaUaSS5Ks7kXUW5LsMeT6bVW1YMjP2NU9o6qOq6qBqhp4YJn3WwEAAAC6sNkFUz0rXudL7/ecNfRb9Tj/S1prU4b8PLa6Qa2181pr/a21/l3HbRnfCAAAAADwu2ZzDabmJTmoqqYlGdtau2UN/aYmuXPTlQUAAADAcNksg6nW2qNJ5ie5IGvYLdU7e+qMJJ/fVHUBAAAAMHw2x2/lW2FOkkvz61f6kuQlVfXdJGOSPJLk80O+kS8ZPGPqD4dcn9Bau26tTxk/NZk9MEwlAwAAALC+NttgqrV2WYacIdVaW5xktYeZ9+5fmOTCka4LAAAAgOGxWb7KBwAAAMCWTzAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCdGdV1A1xYtXZS+i/qe9viFMxcOYzUAAAAAWw87pgAAAADohGAKAAAAgE4IpgAAAADohGAKAAAAgE4IpgAAAADoROffyldV85Oc2lq7YkjbB5K8LskfJ3lfa+3zvfZ/SDLQWruwqirJXyeZmaQluT/Je1trt/X6Lk7S31p7cG3P3+vxJzJw731PfwGzn5nMfvjpjwcAAADYSm0OO6bmJJmxStuMJKcm+b9J3l9V261m3HuS7Jdkcmtt9yR/l+RrVfWMkSwWAAAAgOGxOQRTc5McWlXbJ0lVTUgyPsmSJA8kuSqDu6JW9eEM7pBaliSttW8muSbJ0SNfMgAAAAAbq/NgqrW2NMl3khzSa5qR5JIMvp6XJJ9K8hdVte2KMVX1X5I8o7V2zyrTDSR5+bqeWVXHVdVAVQ08sKytqzsAAAAAI6DzYKpn6Ot8M3rXSZLW2r0ZDK7evh7z1Po8rLV2Xmutv7XWv+u49RoCAAAAwDDbXIKpeUkOqqppSca21m5Z5f4nM/jq3jZJ0lr7eZJfVNWLV+k3LYO7pgAAAADYzG0WwVRr7dEk85NckCG7pYbcvyvJHUkOHdJ8epKzqmpsklTVwUn2yuCZVQAAAABs5kZ1XcAQc5Jcmt/+hr4V/i7Jd4dcfz7Js5LcVlWjk2yXZGJrbfkGPXX81GS2TVYAAAAAm1q19rt/+HdV7ZDksiQ3tdY+siFj+/v728CAYAoAAABguFTVza21/nX125x2TD1tvVcBX9t1HQAAAACsv83ijCkAAAAAtj6CKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6MarrArq2aOmi9F3U13UZW4yFMxd2XQIAAADwO8KOKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOjRvoBVTU/yamttSuGtH0gye5Jzuz97JnkZ0l+nuTjrbVrquq5Sb6U5IVJRidZ3Fp7fVVNSPL11trEVZ5zeZL/1Vr7Su/6/CR3t9ZOX1t9ez3+RAbuvW84lgoAAADABtgUO6bmJJmxStuMXvu/JjmvtfaS1treSd6b5MW9Pqck+bfW2uTW2suTnLyO57wvySlV9ayq2i/Jvkk+O1yLAAAAAGB4jfiOqSRzk3yiqrZvrT3e2/E0PoM7pq5vrV2+omNr7fYkt/cun5fkm0Pu3ba2h7TWFlfVeUlOS/IHSU5srT05nAsBAAAAYPiM+I6p1trSJN9JckivaUaSS5LsleSWtQw9O8mXqurqqvrrqhq/Ho87o/ecRa21a9bUqaqOq6qBqhp4YFlbr3UAAAAAMLw21eHnQ1/nW/Ea32+oqsuq6vaqujRJemdSvTjJ+Un2SPLdqtp1Hc+ZlKSS7FFVa1xba+281lp/a61/13G14asBAAAAYKNtqmBqXpKDqmpakrGttVuSLEoybUWH1tqbksxKsvOQtodaa/+jtfanSW5Ksv+aHtALor6Q5E+TfD/Ju0dgHQAAAAAMk01xxlRaa4/2vp3vgvx6t9T/SPJXVXXYkHOmxq0YU1WvSXJDa21ZVe2Y5CVJ1vb1eX+W5PuttflVdXeS66vqq621B9Za3PipyeyBp7UuAAAAAJ6+TRJM9cxJcml6r/S11h6rqkOTfKaqPpvkJ0keSfKJXv+9k/xDVT2VwZ1dX2yt3dQ7PP1lVbVkyNx/keTDSab35v5xVX0ugwehHzPSCwMAAABgw1VrW/fh3/39/W1gwI4pAAAAgOFSVTe31vrX1W9TnTEFAAAAAL9BMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRCMAUAAABAJwRTAAAAAHRiVNcFdG3R0kXpu6hvRJ+xcObCEZ0fAAAA4HeRHVMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdGJEg6mqml9Vf7RK299U1R1VtaCqHqqqe3ufrxzS58+ranlVPXNI2wFV9XCv721VdWVVPad374NV9aUhfY+uqn8dybUBAAAAsHFGjfD8c5LMSHLFkLY3JPmz1tq3q+rCJF9vrc1dZdxRSW5K8qYkFw5p/3Zr7dAkqapTk7wnyceTnJVkoKpemWRRkk8kOWh9Ctzr8ScycO99G7gsAAAAADbWSL/KNzfJoVW1fZJU1YQk45Ncu6YBVfWSJDsk+WgGA6rV9akkOyb5aZK01p5KckKSs5OcluSC1toPh2sRAAAAAAy/Ed0x1VpbWlXfSXJIkn/J4O6pS1prbS3DjsrgTqtvJ3lZVT2ntfZ/e/deVVULkjw7yS+SfGTIs66rqjuTHJxkz+FfDQAAAADDaVMcfr7idb70fs9ZR/8ZSf5na+1XSS5NcuSQe99urU1prb0wyZczuDsqSVJVOyTpTzI6ya5re0BVHVdVA1U18MCytWVkAAAAAIyUTRFMzUtyUFVNSzK2tXbLmjpW1aQk/zXJv1XV4gyGVKt9nS/J5Un2H3L935P8c5K/S3Lm2gpqrZ3XWutvrfXvOq7WeyEAAAAADJ8RD6Zaa48mmZ/kgqx7t9RRSWa31ib0fsYneX5VvWg1ff8wyT1JUlV9GTxU/dNJzkvyoqp67TAtAQAAAIARMNLfyrfCnAy+ljdjHf1mJPnjVdou67XfmF+fMVVJHk7yrt5B6Ock+fPW2vIkqaoTkvxTVU1prT2x1ieOn5rMHtjA5QAAAACwsWrt55Bv+fr7+9vAgGAKAAAAYLhU1c2ttf519dsUZ0wBAAAAwG8RTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQiVFdF9C1RUsXpe+ivq7L2KIsnLmw6xIAAACA3wF2TAEAAADQCcEUAAAAAJ0QTAEAAADQCcEUAAAAAJ0QTAEAAADQiU0aTFXV/Kr6o1Xa/qaq7qiqBVX1UFXd2/t8ZVVNqKrHetd3VNU/VdXo3rgDqurrvc8frKovDZnz6Kr61025NgAAAAA2zKhN/Lw5SWYkuWJI2xuS/Flr7dtVdWGSr7fW5iZJVU1Ick9rbUpVbZvk35K8NcnFq8x7VpKBqnplkkVJPpHkoPUpaK/Hn8jAvfc97QWxGrOfmcx+uOsqAAAAgM3cpg6m5ib5RFVt31p7vBc8jU9y7boGttZ+WVXfSfL81dx7qqpOSPKFJN9JckFr7YfDWjkAAAAAw2qTvsrXWluaweDokF7TjCSXtNbausZW1Zgk+yb532uY+7okdyY5OMlpw1IwAAAAACOmi8PPV7zOl97vOevo/5KqWpBkaZL7Wmu3ra5TVe2QpD9I8kXlAAAgAElEQVTJ6CS7rm3CqjquqgaqauCBZevMxAAAAAAYAV0EU/OSHFRV05KMba3dso7+97TWpiR5aZLpVXXYGvr99yT/nOTvkpy5tglba+e11vpba/27jqsNLB8AAACA4bDJg6nW2qNJ5ie5IOveLTV03P1JTk7yV6veq6q+DB6i/ukk5yV5UVW9djjqBQAAAGBkbOrDz1eYk+TS/PqVvvU1L8nsqnrVioaqqiTnJPnz1tryXtsJSf6pqqa01p5Y64zjpyazBzawDAAAAAA2Vq3HueNbtP7+/jYwIJgCAAAAGC5VdXNrrX9d/bo4YwoAAAAABFMAAAAAdEMwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdEIwBQAAAEAnBFMAAAAAdGJU1wV0bdHSRem7qK/rMrY4C2cu7LoEAAAAYDNnxxQAAAAAnRBMAQAAANAJwRQAAAAAnRBMAQAAANAJwRQAAAAAnRjRb+WrqvlJTm2tXTGk7QNJ/iTJ51pr83pt30vyldbaJ3rX/2+Si5M8lORDrbVDe+2HJDklyX9JsjzJ95Kc1Fq7r6ouT/K/Wmtf6fU9P8ndrbXT11bjXo8/kYF77xvGVQMAAACwPkZ6x9ScJDNWaZuR5FtJ9kuSqnp2kkeTvGJIn1ckuW7ooKqamOTzSWa21vZorU3JYHg1odflfUlOqapnVdV+SfZN8tlhXQ0AAAAAw2akg6m5SQ6tqu2TpKomJBmfIcFU7/fXk+xag3ZL8lhr7f9bZa4PJ/lka+3OFQ2ttctba9f0Pi9Ocl6S05J8IcmJrbUnR2hdAAAAAGykEQ2mWmtLk3wnySG9phlJLkkykGRiVW2XwWDq+gy+lrdn7/rfVzPdXkluWccjz+g9a9GKwAoAAACAzdOmOPx86Ot8M5LMaa09nmRRkmlJpie5MYPh1H69n+tWM89KVfXsqlpQVXdX1YeG3JqUpJLsUVVrXFtVHVdVA1U18MCy9nTXBQAAAMBG2BTB1LwkB1XVtCRjW2srdj1dl2T/JDu21n6a5Ib8Opha3Y6pFUFWWmtLe2dMnZdkhyTpBVFfSPKnSb6f5N1rKqi1dl5rrb+11r/ruBqGJQIAAACwoUb0W/mSpLX2aO/b+S7I4O6pFf49yd8nmd+7vi2Du6eem8EQalWnJbmsqm4Ycs7UuCH3/yzJ91tr86vq7iTXV9VXW2sPDNtiAAAAABg2Ix5M9cxJcml+8xv6rkvy4iSnJklr7amq+r9JftRa+9WqE7TWFlbV+5P8U1XtmGRpkvuSfLyqnpPBw9Gn9/r+uKo+l8Ew65i1VjZ+ajJ7YCOXBwAAAMCGqta27jOW+vv728CAYAoAAABguFTVza21/nX12xRnTAEAAADAbxFMAQAAANCJtQZTVbVNVe23qYoBAAAAYOux1mCqdwj532+iWgAAAADYiqzPq3zfrKo3V1WNeDUAAAAAbDVGrUefDyZ5RpJfVtVjSSpJa639lxGtDAAAAIAt2jqDqdbajpuiEAAAAAC2Lut8la8G/T9V9Te96xdW1R+MfGkAAAAAbMnW54ypLyR5RZK3964fTXL2iFUEAAAAwFZhfc6Y2re1Nq2qvpskrbWfVtV2I1wXAAAAAFu49dkx9WRVbZukJUlV7ZrkVyNaFQAAAABbvPUJps5KclmS51TV3yW5NsmpI1oVAAAAAFu89flWvour6uYkByWpJIe31u4c8coAAAAA2KKtM5iqqv/WWvtSkruGtH2qtXbyiFYGAAAAwBZtfQ4/f0tVLW+tXZwkVfWFJNuPbFkAAAAAbOnWJ5g6IsnlVfWrJH+c5KHW2gkjWxYAAAAAW7o1BlNVtfOQy3clmZfk35OcUlU7t9YeGuniAAAAANhyrW3H1M1JWgYPPF/x+w29n5bkxSNeHQAAAABbrDUGU6213TZlIQAAAABsXbZZV4eqek9VPWvI9U5V5YwpAAAAADbKOoOpJMe21n624qK19tMkx45cSQAAAABsDdYnmNqmqmrFRVVtm2S7kSsJAAAAgK3B2g4/X+GKJF+tqnMzeOj58Un+94hWBQAAAMAWb32CqQ8n+bMk787gN/N9M8kXR7IoAAAAALZ81VrruoZOjd1tbHvp7Jeus9/CmQs3QTUAAAAAv/uq6ubWWv+6+q1xx1RVfbW19taqWpjBV/h+Q2tt0kbWCAAAAMBWbG2v8r2/9/vOJCcNaa8kp41YRQAAAABsFdYYTLXW7u99fGlr7T+G3quqPUa0KgAAAAC2eGt7le/dSU5I8uKqum3IrR2T/PtIFwYAAADAlm1tr/L9jyTfSHJqkpOHtD/SWntoRKsCAAAAYIs3ot/KV1Xzk5zaWrtiSNsHkuye5Kkkr8ngwerLk7y1tXZvVS1O8kiSX/aGXNNae19VVZK/TjKzN+b+JO9trd1WVTsmWZDkkNba96tqdJJbkryrtXbj2mrsH79tGzhuh/Vb0OyH168fAAAAwFZso7+Vb5jMSTIjyRVD2mYk+dckk5NMaq39qqpekOQXQ/oc2Fp7cJW53pNkvySTW2vLqup1Sb5WVS9vrT1SVX+V5Owkr0vyoSTXrSuUAgAAAKA724zw/HOTHFpV2ydJVU1IMj7JsiT3t9Z+lSSttSWttZ+uY64PZ3CH1LLemG8muSbJ0b3rryb5VVX9ZZLjk/zVsK8GAAAAgGEzojumWmtLq+o7SQ5J8i8Z3C11Se/n2qp6VZKrkvxza+27Q4ZeXVUrXuW7KMmXkjyjtXbPKo8YSPLyIdcfSHJnkuPWdg5WVR2X5Lgk+f1n1tNdHgAAAAAbYaR3TCW/fp0vvd9zWmtLkrwsg7uafpXkqqo6aMiYA1trU3o/Z65l7lVTpUMyePbUxLUV1Fo7r7XW31rr33WcYAoAAACgC5simJqX5KCqmpZkbGvtliRprT3eWvtGa+2kJJ9McviaJmit/TzJL6rqxavcmpbBXVOpqvFJ3pfkD5K8vqomDf9SAAAAABguIx5MtdYeTTI/yQUZ3D2VqprWC5JSVdskmZTkP9Yx1elJzqqqsb1xByfZK4PnWCXJmUk+2duN9cEkZ/e+yQ8AAACAzdBIfyvfCnOSXJpfv9L3nCTnrzgUPcl3kvzDkP5Dz5i6rbX2jiSfT/KsJLdV1egk2yWZ2FpbXlWvTfL7GTyLKq21r1XVsUnekcEzqtZs/NRk9sDGrg8AAACADVStta5r2GBVtUOSy5Lc1Fr7yMbM1d/f3wYGBFMAAAAAw6Wqbm6t9a+r36baMTWseq8HvrbrOgAAAAB4+jbF4ecAAAAA8FsEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCdGdV1A1xYtXZS+i/rW2W/hzIWboBoAAACArYcdUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0YkS+la+q5ic5tbV2xZC2DyTZPclTSV6TpCVZnuStrbV7q2pxkh+11l41ZMyCJKNaaxOHtH0uyVuSvLC19qte2weT7NVa+2+966OTvL219oZ11brX409k4N771r2o2c9MZj+87n4AAAAArJeR2jE1J8mMVdpmJLk/yfgkk1prfUnelORnQ/rsWFUvTJKq2nPVSatqm96YHyXZf8its5LsXVWvrKpnJflEkvcO01oAAAAAGAEjFUzNTXJoVW2fJFU1IYOB1LIk96/Y6dRaW9Ja++mQcV9N8rbe56MyGHANdWCS25Oc07uf3jxPJTkhydlJTktyQWvth8O7JAAAAACG04gEU621pUm+k+SQXtOMJJf0ft5YVQuq6u+rauoqQ+cmOaL3+Y1JvrbK/RVh1WUZDL5GD3nmdUnuTHJwBsOpNaqq46pqoKoGHljWNnh9AAAAAGy8kTz8fOjrfDOSzGmtLUnysiR/leRXSa6qqoOGjHkoyU+rakYGQ6ZlK25U1XZJXp9kXmvt50luTPK6Ifd3SNKfZHSSXddWWGvtvNZaf2utf9dxtXGrBAAAAOBpGZHDz3vmJflMVU1LMra1dkuStNYeT/KNJN+oqp8kOTzJVUPGXZLBV/JmrTLfIUmemWRhVSXJuAwGV//au//fk/xzkp8kOTPJkcO/JAAAAACGy4gFU621R3vfzndBemdF9UKq/6+19uPeQeaTkty2ytDLkjwvyRUZPJdqhaOSvKu1tmKuZyS5t6rGJXlJkjckmZLkiSTvrKrXttb+bZ2Fjp+azB542usEAAAA4OkZyVf5ksFAanKS/9m7fk6Sr1XV7RkMpJ5K8g9DB7TWHmmtfbq19sSKtl749Ef59e6otNZ+keTaDJ5FdU6SP2+tLe8drH5Cks/1Xv8DAAAAYDNUrW3dh3/39/e3gQE7pgAAAACGS1Xd3FrrX1e/kd4xBQAAAACrJZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6IZgCAAAAoBOCKQAAAAA6MarrArq2aOmi9F3UN6xzLpy5cFjnAwAAANgS2TEFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0QjAFAAAAQCcEUwAAAAB0YtSmelBVzU9yamvtiiFtH0jyuiS/31qb2Gv7gySnJXl+kkeS3J/k5NbawiHjbk1yR2vtqCFtlyf5X621r/Suz09yd2vt9LXVtdfjT2Tg3vuGZ5ErzH5mMvvh4Z0TAAAAYAuzKXdMzUkyY5W2GUlOXXFRVc9N8tUkH2mt/dfW2rTe/ZcM6bNnBuvev6qeMWSu9yU5paqeVVX7Jdk3yWdHZCUAAAAAbLRNtmMqydwkn6iq7Vtrj1fVhCTjkywZ0ufEJBe11q5b0dBau3aVed6e5CtJ9kxy2P/f3v0Ha1qW9wH/XrJKwB/EKM4IUjYSTEZYArhJmDG1IGqoKJGKdTc/CqkWI6WO2jiSRltMMyPRJBKnxHRNmZJmumAQCJWxxNhslSYBj4S6WS0qsiLGJisyGKWAhKt/nBc5Hvbsvuzuee+znM9nZmff537v53mvZ+aad8/57v08T+YDr3T39qralPnVVj+e5Pzu/s4ynQsAAAAAe2lmK6a6+64kNyU5bTK0IckVSXrBtGOS3LybQ712st/mJBsXvfcbk+Nv6+5PLHWAqjq3quaqam7Hvb3UNAAAAACW0axvfr7wcr4Nk+0lVdWNVfW5qvrtyfaPJdnR3V9O8vEkJ1bV0xfsclySSvIjVbXkuXX3pu5e393rDz249uJ0AAAAANhTsw6mrklyalWdmOSg7l68OmpbkhMf3ujun0jyziSHTIY2Zj502p7ktiRPS/LqJJkEUb+T5OeTfCHJG5fvNAAAAADYW7O8x1S6+1uTp/Ndmp2vlrokyY1Vdf2C+0wdnHw3eHpNkuO6+6uTsVOSvCPJ7yV5Q5IvdPeWqvp8kj+vqg91945dFnXYCcmFc3t/cgAAAAA8JjMNpiY2J7kqj35CX7r7/1bVa5P8elUdnuRvk3w9ya8meVGSrz4cSk18Isnzq+rIJG9PctLkOH89ufzvPUl+YTlPBgAAAIA9U92r++bf69ev77k5K6YAAAAA9pWq+nR3r9/dvFnfYwoAAAAAkgimAAAAABhEMAUAAADAEIIpAAAAAIYQTAEAAAAwhGAKAAAAgCEEUwAAAAAMIZgCAAAAYAjBFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhhBMAQAAADCEYAoAAACAIQRTAAAAAAwhmAIAAABgCMEUAAAAAEMIpgAAAAAYQjAFAAAAwBCCKQAAAACGEEwBAAAAMIRgCgAAAIAhBFMAAAAADLFmdAGjbbtrW9Zdtm50GQAAALDstp69dXQJ8D2smAIAAABgCMEUAAAAAEMIpgAAAAAYQjAFAAAAwBCCKQAAAACGWPZgqqq2VNVPLRp7Z1V9tqpuqapvVNXtk9d/UlVPqKr3V9VfVdXWqvpUVf3ggn1PqKpeeMyqOmJyjB+YbD99sn3kcp8fAAAAAHtmzQw+Y3OSDUmuXzB2epI3dPcnq+o/J/lId1+ZJFW1MclhSY7r7oeq6jlJvr1g341Jbpj8fX2SdPdXquoDSS5Kcu7k703d/eXdFXfM/Q9k7vY79vIUAQAAYAW68J7RFcAuzeJSviuTvKKqDkySqlqb+eDphiXmPzvJ17r7oSTp7ju7++7JvpXkrCTnJHlZVX3fgv3el+Skqnpzkp9M8pv7/EwAAAAA2GeWPZjq7ruS3JTktMnQhiRXdHcvscuHkrxycmnfb1bVCQvee2GS27v7tiRbkrx8wed8J8nbMh9Qvbm7H9i3ZwIAAADAvjSrm58/fDlfJn9vXmpid9+Z5IeT/HKSh5J8vKpOnby9Mcnlk9eXT7YX+sdJvpbk2F0VU1XnVtVcVc3tuHepfAwAAACA5TSLe0wlyTVJfquqTkxyUHffvKvJ3X1/ko8m+WhV/U2SV1XVliSvTnJGVf1KkkryjKp6anf/XVUdn+SlSU5KckNVXd7dX1vi+JuSbEqS9YcdIJkCAAAAGGAmK6a6+1uZv/Tu0uxitVSSVNWJVXXY5PUTkhyX5MtJXpLkf3f3Ed29truPTPLhzIdWleQDmb+E744k703yG8t1PgAAAADsvVmtmErmA6mr8sglfUt5VpIPPnyz9Mzfn+o/JPndJFcvmvvhJG9MclCSO7r7Y5Px30lyTlX9o+7+n7v6sK393Ky97+LpzwIAAAD2FxdcN7oCprD9otNHlzBMLX0P8tXhwGcf3c8+WzAFAAAAjPF4DKaq6tPdvX5382Z183MAAAAA+B6CKQAAAACGEEwBAAAAMIRgCgAAAIAhBFMAAAAADLFmdAGjrTv8kMw9Du9+DwAAALDSWTEFAAAAwBCCKQAAAACGEEwBAAAAMIRgCgAAAIAhBFMAAAAADCGYAgAAAGAIwRQAAAAAQwimAAAAABhCMAUAAADAEIIpAAAAAIYQTAEAAAAwhGAKAAAAgCEEUwAAAAAMIZgCAAAAYAjBFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhlgzuoDRtt21LesuWze6DGCgrWdvHV0CAADAqmTFFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhhBMAQAAADDETJ/KV1Vbkry7u69fMPbOJBuTPJDkHyS5Z/Ln60len+Qj3X3sgvm/neSsJEd090OTsbcmOaa7XzfZ/tkkP9Pdp++upmPufyBzt9+xb04Q2P9ceM/oCgAAAFatWa+Y2pxkw6Kx05O8obuPT3Jtkrd19/Hd/ZLFO1fVE5KcmeQrSV604K33J3lBVb2wqr4/ya8l+VfLcQIAAAAA7BuzDqauTPKKqjowSapqbZLDktww5f6nJPmrJB/I/CqrJEl3P5jkvCSXJHlPkku7+0v7rGoAAAAA9rmZBlPdfVeSm5KcNhnakOSK7u4pD7Ex86uurs58wPXEBcf+sySfS/KSzIdTAAAAAKxgI25+vvByvg2T7d2qqicleXmSa7r7m0luTPKyBe8/Jcn6JE9McuhujnVuVc1V1dyOe6fNxAAAAADYl2Z68/OJa5L8VlWdmOSg7r55yv1OS3JIkq1VlSQHJ7k3yXWT99+V5A+S/E2S9yV5zVIH6u5NSTYlyfrDDpBMAQAAAAww82Cqu781eTrfpZlytdTExiSv7+7NSVJVT05ye1UdnOSozN9E/fjMP93vn1fVS7v7Y/u0eAAAAAD2mRErppL5QOqqPPoJfTs1CZ9+KskbHh7r7m9X1Q1JXpn5J/C9pbvvm8w/L8nvV9Xx3f3Aro69tZ+btfddvGdnAez/Lrhuybe2X3T6DAsBAABYfYYEU919dZLayfg5i7a3Jzl2svkDO5n/TyYvr1g0Ppfk+fugVAAAAACWyYibnwMAAACAYAoAAACAMQRTAAAAAAwhmAIAAABgiFFP5Vsx1h1+SOY8eQsAAABg5qyYAgAAAGAIwRQAAAAAQwimAAAAABhCMAUAAADAEIIpAAAAAIYQTAEAAAAwhGAKAAAAgCEEUwAAAAAMIZgCAAAAYAjBFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhhBMAQAAADCEYAoAAACAIQRTAAAAAAwhmAIAAABgCMEUAAAAAEMIpgAAAAAYYs3oAkbbdte2rLts3egyZmLr2VtHlwAAAADwXVZMAQAAADCEYAoAAACAIQRTAAAAAAwhmAIAAABgCMEUAAAAAEPM5Kl8VbUlybu7+/oFY29O8rIkpyS5NUkl+XaSX0iyNsmvT6b+UJKvJvl/ST6T5NIkv9Tdr1hwrAOS3JTkLd39icnYHyf5YHf/4a5qO+b+BzJ3+x17f5IAAAAAPCazWjG1OcmGRWMbkrw7yW3dfXx3/2iSy5L8m+6+fjJ2fJK5JD872f5nOzt4d/99kvOSXFJVT6yqjfPDuw6lAAAAABhnJiumklyZ5Neq6sDuvr+q1iY5LMmdi+Y9Lcnde/IB3X1jVf1ZkguT/EySl+5xtQAAAAAsu5kEU919V1XdlOS0JH+U+dVSVyTpJEdV1S1Jnprk4CQ/sRcf9ctJvpLk4u7+4t5VDQAAAMBymuXNzxdezrdhsp08cinfUUnenGTTXnzGi5Lck+TYXU2qqnOraq6q5nbc23vxcQAAAADsqVkGU9ckObWqTkxyUHffvJM512Y+XHrMqurJSd6T5MVJDq2qly81t7s3dff67l5/6MG1Jx8HAAAAwF6aWTDV3d9KsiXzT9XbvMS0n0xy2x5+xL9N8qHu/j+ZvxH6+6rq+/bwWAAAAAAss1nd/Pxhm5Ncle99Qt/D95iqJA8kef0Uxzm1qhbeOP21Sc5M8qNJ0t23VNX1Sd6e5F27OtDWfm7W3nfx9GewP7vgutEVAOzS9otOH10CAAAwQzMNprr76swHUA9vb09y0G72OXnR9pYl9nneonlv2sMyAQAAAJiBWd5jCgAAAAC+SzAFAAAAwBCCKQAAAACGEEwBAAAAMMSsn8q34qw7/JDMeQoUAAAAwMxZMQUAAADAEIIpAAAAAIYQTAEAAAAwhGAKAAAAgCEEUwAAAAAMIZgCAAAAYAjBFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhhBMAQAAADCEYAoAAACAIQRTAAAAAAwhmAIAAABgCMEUAAAAAEMIpgAAAAAYQjAFAAAAwBCCKQAAAACGEEwBAAAAMIRgCgAAAIAhBFMAAAAADCGYAgAAAGAIwRQAAAAAQwimAAAAABhCMAUAAADAECsmmKqqM6uqq+pHFo2/paruq6pDFoydXFX3VNVfVtXnqurfLRj/yKxrBwAAAOCxWzHBVJKNSW5IsmEn459Kcuai8U929wlJ1if5uap6wfKXCAAAAMC+siKCqap6SpIXJnldFgRTVXVUkqckeUfmA6pH6e5vJ/l0kqOWv1IAAAAA9pUVEUwleVWS/97dn0/yjao6cTK+McnmJJ9M8sNV9azFO1bVM5KclGTbtB9WVedW1VxVze3YsWPvqwcAAADgMVspwdTGJJdPXl+eR1ZHbUhyeXc/lOSqJK9ZsM8/rKq/TPLHSS7q7qmDqe7e1N3ru3v9oYceuvfVAwAAAPCYrRldwGTF04uTHFtVneSAJF1Vf5Dk6CQfq6okeVKSLyW5ZLLrJ7v7FQNKBgAAAGAfWAkrps5K8vvdfWR3r+3uI5LcnuTiJBdOxtZ292FJDq+qI4dWCwAAAMA+MXzFVOYv27to0diHk7wlydWLxq/O/OV9N+7ieKdW1Z0Ltl/T3X++1OStX70nay+4brdFbr/o9N3OAQAAAGB6w4Op7j55J2PvT/L+nYy/dcHmlp28vyXJQfuuOgAAAACWy0q4lA8AAACAVUgwBQAAAMAQgikAAAAAhhBMAQAAADDE8Jufj7bu8EMy54l7AAAAADNnxRQAAAAAQwimAAAAABhCMAUAAADAEIIpAAAAAIYQTAEAAAAwhGAKAAAAgCEEUwAAAAAMIZgCAAAAYAjBFAAAAABDVHePrmGoqvq7JLeOrgN24ZlJvj66CNgNfcpKp0fZH+hTVjo9ykqnR1eWI7v70N1NWjOLSla4W7t7/egiYClVNadHWen0KSudHmV/oE9Z6fQoK50e3T+5lA8AAACAIQRTAAAAAAwhmEo2jS4AdkOPsj/Qp6x0epT9gT5lpdOjrHR6dD+06m9+DgAAAMAYVkwBAAAAMMSqCKaq6rSqurWqvlhVF+zk/QOr6orJ+zdW1drZV8lqN0Wfvqiqbq6qB6vqrBE1srpN0aNvrarPVtVnqurjVXXkiDpZ3abo01+sqq1VdUtV3VBVzx9RJ6vX7np0wbyzqqqrytOlmLkpvkvPqaodk+/SW6rq9SPqZPWa5ru0qv7p5GfTbVX1X2ddI9N73F/KV1UHJPl8kpcmuTPJp5Js7O7PLphzXpLjuvsXq2pDkjO7+7VDCmZVmrJP1yZ5WpJfSnJtd185+0pZrabs0VOS3Njd91bVG5Oc7LuUWZqyT5/W3bZsYgEAAANpSURBVN+cvD4jyXndfdqIell9punRybynJrkuyZOSnN/dc7OuldVryu/Sc5Ks7+7zhxTJqjZljx6d5ENJXtzdd1fVs7r7b4cUzG6thhVTP57ki939pe5+IMnlSX560ZyfTnLZ5PWVSU6tqpphjbDbPu3u7d39mSQPjSiQVW+aHv3T7r53svkXSZ4z4xphmj795oLNJyd5fP8PHSvNND+XJsm/T/KeJPfNsjiYmLZPYZRpevRfJLmku+9OEqHUyrYagqnDk3xlwfadk7GdzunuB5Pck+QZM6kO5k3TpzDSY+3R1yX56LJWBI82VZ9W1b+sqtsy/4v/m2ZUGyRT9GhVnZDkiO7+yCwLgwWm/Tf/1ZPL96+sqiNmUxokma5Hn5fkeVX1v6rqL6rK6ugVbDUEUztb+bT4f0enmQPLSQ+y0k3do1X1c0nWJ3nvslYEjzZVn3b3Jd19VJK3J3nHslcFj9hlj1bVE5K8L8m/nllF8GjTfJf+tyRru/u4JH+SR64+gVmYpkfXJDk6yclJNib5var6/mWuiz20GoKpO5MsTPCfk+Svl5pTVWuSHJLkGzOpDuZN06cw0lQ9WlUvSfIrSc7o7vtnVBs87LF+l16e5FXLWhF8r9316FOTHJtkS1VtT3JSkmvdAJ0Z2+13aXffteDf+Q8mecGMaoNk+t/x/6i7v9Pdtye5NfNBFSvQagimPpXk6Kr6wap6UpINSa5dNOfaJGdPXp+V5H/04/2u8Kw00/QpjLTbHp1cfvIfMx9KuY6fEabp04U/lJ6e5AszrA922aPdfU93P7O713b32szfr+8MNz9nxqb5Ln32gs0zknxuhvXBNL87XZPklCSpqmdm/tK+L820Sqa2ZnQBy627H6yq85Ncn+SAJJd297aq+tUkc919bZL/lOS/VNUXM79SasO4ilmNpunTqvqxJFcneXqSV1bVu7r7mIFls4pM+V363iRPSfKHk+dH3NHdZwwrmlVnyj49f7Ky7ztJ7s4j/zEFy27KHoWhpuzTN02ebPpg5n9/OmdYwaw6U/bo9UleVlWfTfL3Sd7W3XeNq5pdKQuDAAAAABhhNVzKBwAAAMAKJJgCAAAAYAjBFAAAAABDCKYAAAAAGEIwBQAAAMAQgikAAAAAhhBMAQAAADCEYAoAAACAIf4/Fn/MoyeUWAYAAAAASUVORK5CYII=
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Next we turn our ticker-level strategy into account level actions</span>
<span class="c1">#Join in our rebalanced portfolio and determine how to split value across accounts for a given ticker</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">start_port</span><span class="p">[[</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;shares&#39;</span><span class="p">]],</span> 
                   <span class="n">exec_port</span><span class="p">[[</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">,</span><span class="s1">&#39;new_shares&#39;</span><span class="p">,</span><span class="s1">&#39;new_value&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">,</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]],</span> 
                   <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> 
                   <span class="n">left_on</span> <span class="o">=</span> <span class="s1">&#39;ticker&#39;</span><span class="p">,</span> 
                   <span class="n">right_on</span> <span class="o">=</span> <span class="s1">&#39;ticker&#39;</span><span class="p">)</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;value_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">close</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">shares</span>
<span class="c1">#Calculate the value-weight of each ticker by account</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;tick_alloc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">value_orig</span> <span class="o">/</span> <span class="n">port</span><span class="o">.</span><span class="n">value</span> <span class="c1">#What pct of each ticker is in a given account?</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;tick_alloc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#check our sub-allocations</span>
<span class="k">assert</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tick_alloc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ticker&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tick_alloc</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

<span class="c1">#Recalculate the values proportionately</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;final_shares_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_shares_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_shares</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_value_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_value_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_chg</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;final_allocation_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">final_allocation</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>

<span class="c1">#double check our final_allocation is 100%</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">final_allocation_n</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1">#Now we must double check to ensure we are not allocating buys to accounts with no sells (we cannot just add funds to a Traditional IRA account, for example)</span>
<span class="c1">#accounts with single securities in them which also exist in other accounts can cause issues if we don&#39;t do this</span>
<span class="n">acctsdf</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;accounttype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">new_value_chg_n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">acctsdf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;new_value_chg_n&#39;</span><span class="p">:</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">})</span>
<span class="n">errordf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="p">[</span><span class="n">acctsdf</span><span class="o">.</span><span class="n">new_value_chg_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#a value &gt;0 at the account-level implies we have allocated buys to an account with insufficient sells</span>
<span class="n">erroraccts</span> <span class="o">=</span> <span class="n">errordf</span><span class="o">.</span><span class="n">accountid</span><span class="o">.</span><span class="n">values</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errordf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">accountid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">erroraccts</span><span class="p">)]</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span> <span class="c1">#Loop by security (not by account)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correcting distribution for single-security accounts edge case: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">accountid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">erroraccts</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">])</span>
        <span class="c1">#adjust numerator and denominator for proper recalculation of asset distribution across accounts</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;new_shares_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_shares_n</span> <span class="o">-</span> <span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg_n</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;new_value_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_n</span> <span class="o">-</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_chg_n</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;final_shares_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;new_value_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#remove from denominator</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">port</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">value_orig</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        
        <span class="c1">#recalculate values for this ticker</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;tick_alloc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">value_orig</span> <span class="o">/</span> <span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;tick_alloc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#set new money allocation to zero for funds with insufficient assets</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;final_shares_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;new_shares_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">shares</span> <span class="o">+</span> <span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg_n</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;new_value_chg_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_chg</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">tick_alloc</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;new_value_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">value_orig</span> <span class="o">+</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_chg_n</span>
        <span class="n">port</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">,</span><span class="s1">&#39;final_allocation_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">new_value_n</span> <span class="o">/</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">.</span><span class="n">final_allocation</span>
        
        <span class="n">display</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">ticker</span> <span class="o">==</span> <span class="n">t</span><span class="p">])</span>

<span class="c1">#Cleanup</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">value_orig</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg_n</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_shares&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_shares_n</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_n</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">new_value_chg_n</span>
<span class="n">port</span><span class="p">[</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">final_allocation_n</span>
<span class="n">port</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;value_orig&#39;</span><span class="p">,</span><span class="s1">&#39;tick_alloc&#39;</span><span class="p">,</span><span class="s1">&#39;final_shares_chg_n&#39;</span><span class="p">,</span><span class="s1">&#39;new_shares_n&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_n&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg_n&#39;</span><span class="p">,</span><span class="s1">&#39;final_allocation_n&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">port</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Check our work</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="mf">1.0</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">port</span><span class="o">.</span><span class="n">shares</span><span class="o">+</span><span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg</span><span class="p">)</span><span class="o">-</span><span class="n">port</span><span class="o">.</span><span class="n">new_shares</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">new_value</span><span class="o">-</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">new_shares</span><span class="o">*</span><span class="n">port</span><span class="o">.</span><span class="n">close</span><span class="p">)))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">new_value_chg</span><span class="o">-</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">final_shares_chg</span><span class="o">*</span><span class="n">port</span><span class="o">.</span><span class="n">close</span><span class="p">)))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Lets look at our final portfolio at the account level</span>
<span class="n">display</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accounttype</th>
      <th>accountid</th>
      <th>ticker</th>
      <th>shares</th>
      <th>assetclass</th>
      <th>close</th>
      <th>value</th>
      <th>final_shares_chg</th>
      <th>new_shares</th>
      <th>new_value</th>
      <th>new_value_chg</th>
      <th>final_allocation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VBTLX</td>
      <td>913.483</td>
      <td>BD</td>
      <td>10.39</td>
      <td>9491.08837</td>
      <td>-743.404775</td>
      <td>170.078225</td>
      <td>1767.112759</td>
      <td>-7723.975611</td>
      <td>0.019071</td>
    </tr>
    <tr>
      <th>1</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VBTLX</td>
      <td>772.407</td>
      <td>BD</td>
      <td>10.39</td>
      <td>8025.30873</td>
      <td>-628.595225</td>
      <td>143.811775</td>
      <td>1494.204341</td>
      <td>-6531.104389</td>
      <td>0.016125</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VTIAX</td>
      <td>514.298</td>
      <td>ST</td>
      <td>25.17</td>
      <td>12944.88066</td>
      <td>47.000000</td>
      <td>561.298000</td>
      <td>14127.870660</td>
      <td>1182.990000</td>
      <td>0.152468</td>
    </tr>
    <tr>
      <th>3</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VTSAX</td>
      <td>151.121</td>
      <td>ST</td>
      <td>61.08</td>
      <td>9230.47068</td>
      <td>1.418028</td>
      <td>152.539028</td>
      <td>9317.083821</td>
      <td>86.613141</td>
      <td>0.100550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VTSAX</td>
      <td>151.578</td>
      <td>ST</td>
      <td>61.08</td>
      <td>9258.38424</td>
      <td>1.422316</td>
      <td>153.000316</td>
      <td>9345.259305</td>
      <td>86.875065</td>
      <td>0.100854</td>
    </tr>
    <tr>
      <th>5</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VTSAX</td>
      <td>549.871</td>
      <td>ST</td>
      <td>61.08</td>
      <td>33586.12068</td>
      <td>5.159656</td>
      <td>555.030656</td>
      <td>33901.272475</td>
      <td>315.151795</td>
      <td>0.365862</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>AAPL</td>
      <td>3.140</td>
      <td>ST</td>
      <td>156.15</td>
      <td>490.31100</td>
      <td>-3.140000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-490.311000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VIGAX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>68.02</td>
      <td>0.00000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>1156.340000</td>
      <td>1156.340000</td>
      <td>0.012479</td>
    </tr>
    <tr>
      <th>8</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VSMAX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>62.25</td>
      <td>0.00000</td>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>560.250000</td>
      <td>560.250000</td>
      <td>0.006046</td>
    </tr>
    <tr>
      <th>9</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VSEQX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>26.77</td>
      <td>0.00000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>588.940000</td>
      <td>588.940000</td>
      <td>0.006356</td>
    </tr>
    <tr>
      <th>10</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VWIGX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>24.76</td>
      <td>0.00000</td>
      <td>190.000000</td>
      <td>190.000000</td>
      <td>4704.400000</td>
      <td>4704.400000</td>
      <td>0.050770</td>
    </tr>
    <tr>
      <th>11</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VTRIX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>31.91</td>
      <td>0.00000</td>
      <td>147.000000</td>
      <td>147.000000</td>
      <td>4690.770000</td>
      <td>4690.770000</td>
      <td>0.050623</td>
    </tr>
    <tr>
      <th>12</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VTABX</td>
      <td>NaN</td>
      <td>BD</td>
      <td>21.66</td>
      <td>0.00000</td>
      <td>64.000000</td>
      <td>64.000000</td>
      <td>1386.240000</td>
      <td>1386.240000</td>
      <td>0.014960</td>
    </tr>
    <tr>
      <th>13</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VGSLX</td>
      <td>NaN</td>
      <td>RE</td>
      <td>105.06</td>
      <td>0.00000</td>
      <td>44.000000</td>
      <td>44.000000</td>
      <td>4622.640000</td>
      <td>4622.640000</td>
      <td>0.049887</td>
    </tr>
    <tr>
      <th>14</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VNQI</td>
      <td>NaN</td>
      <td>RE</td>
      <td>52.05</td>
      <td>0.00000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>884.850000</td>
      <td>884.850000</td>
      <td>0.009549</td>
    </tr>
    <tr>
      <th>15</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>VDE</td>
      <td>NaN</td>
      <td>ST</td>
      <td>77.44</td>
      <td>0.00000</td>
      <td>36.000000</td>
      <td>36.000000</td>
      <td>2787.840000</td>
      <td>2787.840000</td>
      <td>0.030086</td>
    </tr>
    <tr>
      <th>16</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>GLD</td>
      <td>NaN</td>
      <td>CS</td>
      <td>120.57</td>
      <td>0.00000</td>
      <td>11.000000</td>
      <td>11.000000</td>
      <td>1326.270000</td>
      <td>1326.270000</td>
      <td>0.014313</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Finally, all new tickers need an account to land in</span>
<span class="n">dport</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">acctsdf</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">port</span><span class="o">.</span><span class="n">accounttype</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#if we have none, skip this step</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Distributing new securities to existing accounts . . .&#39;</span><span class="p">)</span>
    <span class="n">dport</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#account-level fund surplus or deficit - must match these with our orphaned securities</span>
    <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">port</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;accounttype&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">new_value_chg</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">:</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">})</span>
    <span class="c1">#establish sort order so we can allocate tax-efficient account space first</span>
    <span class="n">actype_sortorder</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;RIRA&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="s1">&#39;TIRA&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="s1">&#39;TAXB&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
    <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">acctsdf</span><span class="p">,</span><span class="n">actype_sortorder</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;accounttype&#39;</span><span class="p">)</span>
    <span class="c1">#We make a consequential assumption here that any new_money_in will be allocated 100% in one of the Taxable accounts (first in list).</span>
    <span class="c1">#if you have a Roth-IRA which has not met its contribution limits for the year, it may be preferrential to distribute the funds there first.</span>
    <span class="c1">#IF YOU HAVE NO TAXABLE ACCOUNT AND YOU WISH TO REBALANCE WITH new_money_in &gt; 0 this will cause errors - so we assert here:</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">new_money_in</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acctsdf</span><span class="p">[</span><span class="n">acctsdf</span><span class="o">.</span><span class="n">accounttype</span> <span class="o">==</span> <span class="s1">&#39;TAXB&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">new_money_in</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="p">[</span><span class="n">acctsdf</span><span class="o">.</span><span class="n">accounttype</span> <span class="o">==</span> <span class="s1">&#39;TAXB&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">acctsdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_idx</span><span class="p">,</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_idx</span><span class="p">,</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_money_in</span>
    <span class="c1">#only return accounts that have space</span>
    <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="p">[</span><span class="n">acctsdf</span><span class="o">.</span><span class="n">new_value_chg_sum</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#establish sort order so we can allocate tax-inefficient assets first</span>
    <span class="n">aclass_sortorder</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;ST&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="s1">&#39;CS&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="s1">&#39;RE&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="s1">&#39;ALT&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
    <span class="n">dport</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dport</span><span class="p">,</span><span class="n">aclass_sortorder</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;assetclass&#39;</span><span class="p">)</span>

    <span class="c1">#We loop twice, first to fit whole securities in accounts with tax location in mind, then again without tax location for anything leftover</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1">#loop through orphaned tickers and place them in accounts until all assets are allocated or we are forced to split a security across accounts</span>
        <span class="c1">#  in the first loop we do not allow tax-inefficient assets to wind up in Taxable accounts, in the second loop we relax this constraint</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dport</span><span class="p">[</span><span class="n">dport</span><span class="o">.</span><span class="n">accounttype</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1">#loop through accounts and place the assets</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">aid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">accountid</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">accounttype</span>
                <span class="n">bal</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">new_value_chg_sum</span>
                <span class="c1">#print(&#39;Evaluating {}-{} with {} starting bal&#39;.format(aid,atype,bal))</span>
                <span class="k">if</span> <span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">assetclass</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="s1">&#39;RE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">atype</span> <span class="o">==</span> <span class="s1">&#39;TAXB&#39;</span><span class="p">):</span>
                    <span class="k">continue</span> <span class="c1">#skip this case, since we don&#39;t want to place Bonds and Real-Estate assets in Taxable accounts</span>
                <span class="k">elif</span> <span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">assetclass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="s1">&#39;RE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">atype</span> <span class="o">!=</span> <span class="s1">&#39;TAXB&#39;</span><span class="p">):</span>
                    <span class="k">continue</span> <span class="c1">#skip this case, since we don&#39;t want to place tax-efficient assets into tax sheltered accounts </span>

                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span> <span class="o">+</span> <span class="n">bal</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#it fits</span>
                    <span class="n">bal</span><span class="o">+=</span><span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; FITS </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1"> with </span><span class="si">{}</span><span class="s1"> remaining&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span><span class="n">aid</span><span class="p">,</span><span class="n">atype</span><span class="p">,</span><span class="n">bal</span><span class="p">))</span>
                    <span class="c1">#update our portfolio</span>
                    <span class="n">dport</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;accountid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aid</span>
                    <span class="n">dport</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;accounttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atype</span>
                    <span class="c1">#update account bal for next loop</span>
                    <span class="n">acctsdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bal</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> does not fit in </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span><span class="p">,</span><span class="n">aid</span><span class="p">,</span><span class="n">atype</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Lets see what remains in our accounts after 2 loops . . .&#39;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">acctsdf</span><span class="p">)</span>
                    
    <span class="c1">#Here we are forced to split a security across multiple accounts because no one account can fit it</span>
    <span class="c1">#  in this loop we allow tax-inefficient assets to wind up in Taxable accounts, but only as a last resort</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dport</span><span class="p">[</span><span class="n">dport</span><span class="o">.</span><span class="n">accounttype</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Splitting remaining securities across accounts . . .&#39;</span><span class="p">)</span>
        <span class="c1">#loop through accounts and place portions of asset in each, create a new row in the df for each placement.</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dport</span><span class="p">[</span><span class="n">dport</span><span class="o">.</span><span class="n">accounttype</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">final_shares_chg</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">final_shares_chg</span>
            <span class="n">asset_bal</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span>
            <span class="c1">#if its a tax-inefficent asset, order the accounts by &#39;order&#39;</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">assetclass</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BD&#39;</span><span class="p">,</span><span class="s1">&#39;RE&#39;</span><span class="p">):</span>
                <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">acctsdf</span> <span class="o">=</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">acctsdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">bal</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">new_value_chg_sum</span>
                <span class="k">if</span> <span class="n">asset_bal</span><span class="o">&gt;-</span><span class="n">bal</span><span class="p">:</span>
                    <span class="n">to_move</span> <span class="o">=</span> <span class="o">-</span><span class="n">bal</span>
                    <span class="n">pct_move</span> <span class="o">=</span> <span class="o">-</span><span class="n">bal</span><span class="o">/</span><span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span>
                    <span class="n">asset_bal</span><span class="o">+=</span><span class="n">bal</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_move</span> <span class="o">=</span> <span class="n">asset_bal</span>
                    <span class="n">pct_move</span> <span class="o">=</span> <span class="n">asset_bal</span><span class="o">/</span><span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span>
                    <span class="n">asset_bal</span><span class="o">=</span><span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{}</span><span class="s1"> move </span><span class="si">{}</span><span class="s1"> or </span><span class="si">{}% i</span><span class="s1">nto account </span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">. </span><span class="si">{}</span><span class="s1"> bal remaining </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span><span class="n">to_move</span><span class="p">,</span><span class="n">pct_move</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">accountid</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">accounttype</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span><span class="n">asset_bal</span><span class="p">))</span>
                
                <span class="c1">#update our account to reflect this change</span>
                <span class="k">if</span> <span class="n">asset_bal</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">acctsdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">acctsdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;new_value_chg_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_move</span><span class="o">+</span><span class="n">bal</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">new_shares</span><span class="p">)</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">close</span><span class="p">)</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#create new row in our portfolio for this asset in this account</span>
                    <span class="n">dport</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">dport</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">accounttype</span><span class="p">,</span>
                                            <span class="n">r</span><span class="o">.</span><span class="n">accountid</span><span class="p">,</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">shares</span><span class="p">,</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">assetclass</span><span class="p">,</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">final_shares_chg</span><span class="p">),</span> <span class="c1">#we round down to get back to whole shares</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">new_shares</span><span class="p">),</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">new_shares</span><span class="p">)</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">new_shares</span><span class="p">)</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">close</span><span class="p">)</span><span class="o">-</span><span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="c1">#rounding can cause us to be short of our total allocatable funds</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pct_move</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">new_value</span><span class="p">)</span><span class="o">/</span><span class="n">dport</span><span class="o">.</span><span class="n">new_value</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                                            <span class="n">row</span><span class="o">.</span><span class="n">order</span><span class="p">]</span>
    
                <span class="c1">#finally delete the original row from the df</span>
                <span class="n">dport</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dport</span><span class="p">[</span><span class="n">dport</span><span class="o">.</span><span class="n">accounttype</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
                <span class="c1">#double check our work - we just care that distributed funds &lt; total available funds for this ticker</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">dport</span><span class="p">[</span><span class="n">dport</span><span class="o">.</span><span class="n">ticker</span><span class="o">==</span><span class="n">row</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">new_value_chg</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">.</span><span class="n">new_value_chg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Distributing new securities to existing accounts . . .
 FITS VTABX in 1111-RIRA with -5068.132470695083 remaining
 FITS VGSLX in 1111-RIRA with -445.4924706950824 remaining
 VNQI 884.8499999999999 does not fit in 1111-RIRA
 FITS VNQI in 2222-RIRA with -5559.379323808596 remaining
 VWIGX 4704.400000000001 does not fit in 1111-RIRA
 FITS VWIGX in 2222-RIRA with -854.9793238085958 remaining
 VTRIX 4690.77 does not fit in 1111-RIRA
 VTRIX 4690.77 does not fit in 2222-RIRA
 FITS VTRIX in 3333-TAXB with -5484.389205496322 remaining
 VDE 2787.84 does not fit in 1111-RIRA
 VDE 2787.84 does not fit in 2222-RIRA
 FITS VDE in 3333-TAXB with -2696.5492054963215 remaining
 VIGAX 1156.34 does not fit in 1111-RIRA
 VIGAX 1156.34 does not fit in 2222-RIRA
 FITS VIGAX in 3333-TAXB with -1540.2092054963216 remaining
 VSEQX 588.9399999999999 does not fit in 1111-RIRA
 FITS VSEQX in 2222-RIRA with -266.0393238085959 remaining
 VSMAX 560.25 does not fit in 1111-RIRA
 VSMAX 560.25 does not fit in 2222-RIRA
 FITS VSMAX in 3333-TAXB with -979.9592054963216 remaining
 GLD 1326.27 does not fit in 1111-RIRA
 GLD 1326.27 does not fit in 2222-RIRA
 GLD 1326.27 does not fit in 3333-TAXB
 GLD 1326.27 does not fit in 1111-RIRA
 GLD 1326.27 does not fit in 2222-RIRA
 GLD 1326.27 does not fit in 3333-TAXB

Lets see what remains in our accounts after 2 loops . . .
</pre>
</div>
</div>

<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accountid</th>
      <th>accounttype</th>
      <th>new_value_chg_sum</th>
      <th>order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1111</td>
      <td>RIRA</td>
      <td>-445.492471</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2222</td>
      <td>RIRA</td>
      <td>-266.039324</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3333</td>
      <td>TAXB</td>
      <td>-979.959205</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Splitting remaining securities across accounts . . .
 GLD move 979.9592054963216 or 0.7388836402062338% into account 3333-TAXB. GLD bal remaining 346.3107945036784
 GLD move 346.3107945036784 or 0.26111635979376624% into account 1111-RIRA. GLD bal remaining 0
 GLD move 0 or 0.0% into account 2222-RIRA. GLD bal remaining 0
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Lets see whats left in our accounts, it should be very close to zero</span>
<span class="k">if</span> <span class="n">acctsdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">display</span><span class="p">(</span><span class="n">acctsdf</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accountid</th>
      <th>accounttype</th>
      <th>new_value_chg_sum</th>
      <th>order</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>3333</td>
      <td>TAXB</td>
      <td>0.000000</td>
      <td>3</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1111</td>
      <td>RIRA</td>
      <td>-99.181676</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2222</td>
      <td>RIRA</td>
      <td>-266.039324</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Review our final portfolio with recommended buys/sells in &#39;final_shares_chg&#39; column</span>
<span class="k">if</span> <span class="n">dport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1">#Cleanup</span>
    <span class="n">dport</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dport</span> <span class="o">=</span> <span class="n">dport</span><span class="p">[[</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;shares&#39;</span><span class="p">,</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;new_shares&#39;</span><span class="p">,</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">,</span><span class="s1">&#39;new_value&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">,</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]]</span>
    <span class="n">display</span><span class="p">(</span><span class="n">dport</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">[[</span><span class="s1">&#39;accounttype&#39;</span><span class="p">,</span><span class="s1">&#39;accountid&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;shares&#39;</span><span class="p">,</span><span class="s1">&#39;assetclass&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;new_shares&#39;</span><span class="p">,</span><span class="s1">&#39;final_shares_chg&#39;</span><span class="p">,</span><span class="s1">&#39;new_value&#39;</span><span class="p">,</span><span class="s1">&#39;new_value_chg&#39;</span><span class="p">,</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">]]</span>
    <span class="n">display</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accounttype</th>
      <th>accountid</th>
      <th>ticker</th>
      <th>shares</th>
      <th>assetclass</th>
      <th>close</th>
      <th>value</th>
      <th>new_shares</th>
      <th>final_shares_chg</th>
      <th>new_value</th>
      <th>new_value_chg</th>
      <th>final_allocation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VBTLX</td>
      <td>913.483</td>
      <td>BD</td>
      <td>10.39</td>
      <td>9491.08837</td>
      <td>170.078225</td>
      <td>-743.404775</td>
      <td>1767.112759</td>
      <td>-7723.975611</td>
      <td>0.019071</td>
    </tr>
    <tr>
      <th>1</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VBTLX</td>
      <td>772.407</td>
      <td>BD</td>
      <td>10.39</td>
      <td>8025.30873</td>
      <td>143.811775</td>
      <td>-628.595225</td>
      <td>1494.204341</td>
      <td>-6531.104389</td>
      <td>0.016125</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VTIAX</td>
      <td>514.298</td>
      <td>ST</td>
      <td>25.17</td>
      <td>12944.88066</td>
      <td>561.298000</td>
      <td>47.000000</td>
      <td>14127.870660</td>
      <td>1182.990000</td>
      <td>0.152468</td>
    </tr>
    <tr>
      <th>3</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VTSAX</td>
      <td>151.121</td>
      <td>ST</td>
      <td>61.08</td>
      <td>9230.47068</td>
      <td>152.539028</td>
      <td>1.418028</td>
      <td>9317.083821</td>
      <td>86.613141</td>
      <td>0.100550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VTSAX</td>
      <td>151.578</td>
      <td>ST</td>
      <td>61.08</td>
      <td>9258.38424</td>
      <td>153.000316</td>
      <td>1.422316</td>
      <td>9345.259305</td>
      <td>86.875065</td>
      <td>0.100854</td>
    </tr>
    <tr>
      <th>5</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VTSAX</td>
      <td>549.871</td>
      <td>ST</td>
      <td>61.08</td>
      <td>33586.12068</td>
      <td>555.030656</td>
      <td>5.159656</td>
      <td>33901.272475</td>
      <td>315.151795</td>
      <td>0.365862</td>
    </tr>
    <tr>
      <th>6</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>AAPL</td>
      <td>3.140</td>
      <td>ST</td>
      <td>156.15</td>
      <td>490.31100</td>
      <td>0.000000</td>
      <td>-3.140000</td>
      <td>0.000000</td>
      <td>-490.311000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VIGAX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>68.02</td>
      <td>0.00000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>1156.340000</td>
      <td>1156.340000</td>
      <td>0.012479</td>
    </tr>
    <tr>
      <th>8</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VSMAX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>62.25</td>
      <td>0.00000</td>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>560.250000</td>
      <td>560.250000</td>
      <td>0.006046</td>
    </tr>
    <tr>
      <th>9</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VSEQX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>26.77</td>
      <td>0.00000</td>
      <td>22.000000</td>
      <td>22.000000</td>
      <td>588.940000</td>
      <td>588.940000</td>
      <td>0.006356</td>
    </tr>
    <tr>
      <th>10</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VWIGX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>24.76</td>
      <td>0.00000</td>
      <td>190.000000</td>
      <td>190.000000</td>
      <td>4704.400000</td>
      <td>4704.400000</td>
      <td>0.050770</td>
    </tr>
    <tr>
      <th>11</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VTRIX</td>
      <td>NaN</td>
      <td>ST</td>
      <td>31.91</td>
      <td>0.00000</td>
      <td>147.000000</td>
      <td>147.000000</td>
      <td>4690.770000</td>
      <td>4690.770000</td>
      <td>0.050623</td>
    </tr>
    <tr>
      <th>12</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VTABX</td>
      <td>NaN</td>
      <td>BD</td>
      <td>21.66</td>
      <td>0.00000</td>
      <td>64.000000</td>
      <td>64.000000</td>
      <td>1386.240000</td>
      <td>1386.240000</td>
      <td>0.014960</td>
    </tr>
    <tr>
      <th>13</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>VGSLX</td>
      <td>NaN</td>
      <td>RE</td>
      <td>105.06</td>
      <td>0.00000</td>
      <td>44.000000</td>
      <td>44.000000</td>
      <td>4622.640000</td>
      <td>4622.640000</td>
      <td>0.049887</td>
    </tr>
    <tr>
      <th>14</th>
      <td>RIRA</td>
      <td>2222</td>
      <td>VNQI</td>
      <td>NaN</td>
      <td>RE</td>
      <td>52.05</td>
      <td>0.00000</td>
      <td>17.000000</td>
      <td>17.000000</td>
      <td>884.850000</td>
      <td>884.850000</td>
      <td>0.009549</td>
    </tr>
    <tr>
      <th>15</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>VDE</td>
      <td>NaN</td>
      <td>ST</td>
      <td>77.44</td>
      <td>0.00000</td>
      <td>36.000000</td>
      <td>36.000000</td>
      <td>2787.840000</td>
      <td>2787.840000</td>
      <td>0.030086</td>
    </tr>
    <tr>
      <th>17</th>
      <td>TAXB</td>
      <td>3333</td>
      <td>GLD</td>
      <td>NaN</td>
      <td>CS</td>
      <td>120.57</td>
      <td>0.00000</td>
      <td>8.000000</td>
      <td>8.000000</td>
      <td>964.560000</td>
      <td>964.560000</td>
      <td>0.010565</td>
    </tr>
    <tr>
      <th>18</th>
      <td>RIRA</td>
      <td>1111</td>
      <td>GLD</td>
      <td>NaN</td>
      <td>CS</td>
      <td>120.57</td>
      <td>0.00000</td>
      <td>2.000000</td>
      <td>2.000000</td>
      <td>241.140000</td>
      <td>241.140000</td>
      <td>0.003749</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h2><p>Through this portfolio rebalancing demonstration using Pandas you can see we have achieved a rebalanced portfolio very closely approximating our desired target allocation. We can see how GLD was added as a new security along with 9 others, and AAPL was removed from the portfolio. The remaining securities were bought or sold as required by our target allocation. We accounted for whole-share rounding because most of our assets in this sample are index funds. The final steps had us consider how to distribute newly acquired securities into existing accounts, this was accomplished through iteratively fitting securities into accounts until they all had a home. This simple rebalancer can be adapted to your needs and I urge you grab the code and see if you can improve upon it. I welcome your thoughts or feedback in the comments.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><em>No Solicitation or Investment Advice:</em></strong>
The material contained on this website is for informational purposes only and the author is not soliciting any action based upon such material. The material is not to be construed as an offer or a recommendation to buy or sell a security nor is it to be construed as investment advice. Additionally, the material accessible through this website does not constitute a representation that the investments described herein are suitable or appropriate for any person. This code is provided as-is with no warranties and may contain errors which affect its performance.</p>

</div>
</div>
</div>
 


<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://evgenypogorelov.com/tag/python.html">python</a>
      <a href="https://evgenypogorelov.com/tag/finance.html">finance</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'evgenysblog-1';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Evgeny Pogorelov ",
  "url" : "https://evgenypogorelov.com",
  "image": "https://evgenypogorelov.com/images/profile.jpeg",
  "description": "Side projects and writings"
}
</script>

</body>
</html>